<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet"> 
    <meta name="googlebot" content="noindex, nofollow">

    <title>Video editor</title>
     
 
<link rel="icon" href="https://raw.githubusercontent.com/manyresources/resourcespage/main/logos/newlogo/favicon.ico" type="image/x-icon">
  

<style> 
#general-header{display:none};
.header-menu{top:0;width:100%;user-select:none}.header-menu,.side-menu,.side-menu.active{background-color:rgb(25,25,25)}
.header-menu{display:flex;z-index:4;justify-content:space-between;align-items:center;color:#333;padding:10px 20px;height:45px;box-shadow:0 2px 5px rgba(0,0,0,.3);box-sizing:border-box} 

.logo-container-menu{display:flex;align-items:center;justify-content:center}.logo-container-menu p{margin:auto;font-size:18px;font-weight:bolder;color:rgb(245,245,245)}.logo-menu{height:30px;margin-right:10px;border-radius:50%;object-fit:cover}#languageModal,.side-menu{position:fixed;height:100%}.hamburger{font-size:25px;font-weight:700;cursor:pointer;padding:5px;color:rgb(255,255,255);}.side-menu{top:45px;left:-100%;width:150px;color:#444;padding:20px;box-shadow:2px 0 5px rgba(0,0,0,.3);transition:left .3s;z-index:12}.side-menu.active{left:0}#openModalBtn,#save-lang{background-color:#7c55e6;color:#fff}.side-menu nav ul{list-style:none;padding:0}.side-menu nav ul li{margin:20px 0;padding:10px 5px}.side-menu nav ul li a{color:#fff;text-decoration:none;font-size:18px}

 

 
 


 
.plus-modal-description{margin-bottom:15px;color:#666;font-size:14px}
.plus-textarea{width:100%;min-height:100px;padding:10px;border:1px solid #ccc;border-radius:4px;font-size:14px;resize:vertical;margin-bottom:15px;position:relative}
 
.mention-menu{display:none;position:absolute;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.15);max-height:100px;overflow-y:auto;z-index:1002;min-width:150px}
.mention-menu-item{padding:8px 12px;cursor:pointer;font-size:14px;color:#333}
.mention-menu-item:hover{background-color:#f0f0f0}
.mention-menu-item.selected{background-color:#7c55e6;color:#fff}

 
 
 

 
 
/*ver el 7_3.html*/
.plus-modal-content-0,.plus-modal-content-1 {
    width: calc(100% - 30px);  /* ancho con margen */ 
    background: rgb(48, 48, 48);
    color: white;
    display: flex;
    flex-direction: column;
    padding: 0; 
    height: calc(100vh - 180px);
    min-height: 150px; 
    border-radius: 10px;
    overflow-y: auto;
    box-sizing: border-box;     /* importante para que padding no desborde */
    margin: 0;                   /* asegurarse de que no se rompa el centrado */
}


.plus-modal-header-0,.plus-modal-header-1 { 
    background-color: rgb(130, 30, 30);
    display:none; 
    justify-content: center;
    align-items: center;
    position: relative;
    padding: 6px 15px;  
}

.plus-modal-title-0,.plus-modal-title-1 {
    flex: 1;
    text-align: center;
    margin: 0;
    font-size:16px;
    color:#fff; 
}

.plus-modal-close-0,.plus-modal-close-1 { 
    position: absolute !important;
    top: 0;
    right: 5px;
    width: 24px;
    height: 24px;
    font-size: 26px;
    color: white;
    background: transparent;
    border: none;
    cursor: pointer;
}

 

.script-panel-container { flex: 1; display: flex; flex-direction: column; gap: 5px; overflow-y: auto; padding: 5px 10px 0 10px; background: rgb(50, 65, 69);}

 

.close-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background-color: rgb(25,25,25);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
}


 
 

/*new*/


.tabs-menu-container-settings {
    display: flex;
    background: rgb(35, 45, 48);
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

.tab-button-active-settings,
.tab-button-inactive-settings {
    flex: 1;
    padding: 12px;
    background: transparent;
    border: none;
    color: rgba(255,255,255,0.6);
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tab-button-active-settings {
    color: #fff;
    font-weight: bold;
    border-bottom: 3px solid #7c55e6;
}

.tab-button-inactive-settings:hover {
    background: rgba(255,255,255,0.05);
}

.tab-content-team-settings, 
.tab-content-general-settings,
.tab-content-advanced-settings {
    display: none !important;  /* fuerza ocultar por defecto */
    flex: 1 1 auto;
    flex-direction: column;
    justify-content: flex-start;
    align-items: stretch;
    overflow-y: auto;
    min-height: 0;
    gap: 5px;
}

.tab-content-advanced-settings{
	justify-content: center;
}

.tab-content-team-settings.active, 
.tab-content-general-settings.active,
.tab-content-advanced-settings.active {
    display: flex !important;  /* fuerza mostrar solo el activo */
}

.tab-text-general-settings,
.tab-text-advanced-settings {
    font-size: 22px;
    font-weight: bold;
    color: rgba(255,255,255,0.8);
    text-align: center;
}

/*new*/

/* ESTILOS PARA AMBOS BLOQUES */
.tabs-menu-container-settings-0,
.tabs-menu-container-settings-1 {
    display: flex;
    background: rgb(39, 39, 39);
    border-bottom: 1px solid rgba(255,255,255,0.2);
    user-select:none;
}

.tab-button-active-settings-0,
.tab-button-inactive-settings-0,
.tab-button-active-settings-1,
.tab-button-inactive-settings-1 {
    flex: 1;
    padding: 12px;
    background: transparent;
    border: none;
    color: rgba(255,255,255,0.6);
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tab-button-active-settings-0,
.tab-button-active-settings-1 {
    color: #fff;
    font-weight: bold;
    border-bottom: 3px solid #7c55e6;
}

.tab-button-inactive-settings-0:hover,
.tab-button-inactive-settings-1:hover {
    background: rgba(255,255,255,0.05);
}

.tab-content-team-settings-0, 
.tab-content-general-settings-0,
.tab-content-advanced-settings-0,
.tab-content-team-settings-1, 
.tab-content-general-settings-1,
.tab-content-advanced-settings-1 {
    display: none !important;
    flex: 1 1 auto;
    flex-direction: column;
    justify-content: flex-start;
    align-items: stretch;
    overflow-y: auto;
    min-height: 0;
    gap: 5px;
}

.tab-content-advanced-settings-0,
.tab-content-advanced-settings-1 {
    justify-content: center;
}

.tab-content-team-settings-0.active, 
.tab-content-general-settings-0.active,
.tab-content-advanced-settings-0.active,
.tab-content-team-settings-1.active, 
.tab-content-general-settings-1.active,
.tab-content-advanced-settings-1.active {
    display: flex !important;
}

.tab-text-general-settings-0,
.tab-text-advanced-settings-0,
.tab-text-general-settings-1,
.tab-text-advanced-settings-1 {
    font-size: 22px;
    font-weight: bold;
    color: rgba(255,255,255,0.8);
    text-align: center;
}


/*segundo bloque*/

.tab-loader {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-top: 30px;
}

 
.donut {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 6px solid rgba(255, 255, 255);  
    border-top: 6px solid #7c55e6;  
    animation: spin 1s linear infinite;
}

 
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
 
/* Modal de error (fondo rojo) */
.error-modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:2000}
.error-modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background-color:#f00;padding:20px;border-radius:8px;width:90%;max-width:400px;color:#fff}

.error-modal-content{
  background: rgba(25, 40, 60, 0.55);  
  padding: 20px;
  border-radius: 12px;  
  box-sizing: border-box; 
   color:white;

 
  backdrop-filter: blur(10px) saturate(140%);
  -webkit-backdrop-filter: blur(10px) saturate(140%);

   
  border: 1px solid rgba(255, 255, 255, 0.25);

   
  box-shadow:
    0 0 20px rgba(0, 0, 0, 0.45),
    inset 0 1px 2px rgba(255, 255, 255, 0.2);

   
  background-image: linear-gradient(
    rgba(255,255,255,0.1),
    rgba(0,0,0,0.2)
  );
}


.error-modal-header{display:flex;justify-content:flex-end;margin:0}
.error-modal-close{background:0 0;border:none;font-size:24px;cursor:pointer;color:#fff}
.error-modal-close:hover{opacity:.8}
.error-modal-message{font-size:16px;text-align:center;margin:0}

/* Modal de confirmaci√≥n */
.confirm-modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:2000}
.confirm-modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background-color:#fff;padding:20px;border-radius:8px;width:90%;max-width:400px}
.confirm-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.confirm-modal-header h3{margin:0;color:#333}
.confirm-modal-close{background:0 0;border:none;font-size:24px;cursor:pointer;color:#666}
.confirm-modal-close:hover{color:#000}
.confirm-modal-message{font-size:16px;text-align:center;margin-bottom:20px;color:#333}
.confirm-modal-buttons{display:flex;gap:10px;justify-content:center}
.confirm-btn-yes,.confirm-btn-no{padding:10px 30px;border:none;border-radius:4px;cursor:pointer;font-size:16px}
.confirm-btn-yes{background-color:#28a745;color:#fff}
.confirm-btn-yes:hover{background-color:#218838}
.confirm-btn-no{background-color:#6c757d;color:#fff}
.confirm-btn-no:hover{background-color:#5a6268}





#tab-contents{display:flex;height:100%;box-sizing: border-box;} 
#subcontent-regla{display:flex;background-color: rgb(48,48,48);position: relative;height:100%;box-sizing: border-box;width: 100%; flex: 1;flex-direction: column; } 
.scroll-wrapper{width:100%;height:100%; overflow:auto;border:0;position: relative;flex: 1;
min-height: 0;box-sizing: border-box;}  
.contenedor{position:relative;background-color:transparent;border-top:2px solid rgb(25, 25, 25);box-sizing: border-box;  }/*quitar position relative*/
 
 

.detail-box {
  display:none;
  background-color: rgb(35, 45, 50);
  padding: 5px 5px;           
  border-radius: 4px;         
  color: white;      

  justify-content: center;       
  align-items: center;             
  text-align: center;  
  flex-direction: row;
  gap: 8px;
}
.delete-rectangle {
  display:none;  
  justify-content: center;       
  align-items: center;             
  text-align: center;  
}

.detail-description { 
  font-size:15px;
  background-color: rgb(95, 95, 95);
  padding: 5px 10px;           
  border-radius: 4px;         
  color: white;    
}

#dropdown_property {
  display: block; /* contenedor normal */
}

#dropdown_property select {
  display: flex;    /* el dropdown es un flex item (opcional si quieres flex interno) */
  width: 100%;      /* ocupa todo el ancho de su contenedor */
  padding: 4px 8px;
  font-size: 14px;
  border-radius: 4px;
  border: 1px solid #ccc;
  box-sizing: border-box; /* importante para incluir padding en el ancho */
  background-color: white;
}






#propiedades_regla {
    display: none;
    background-color: rgb(35, 45, 50);
    flex-wrap: wrap;
    /*gap: 10px;*/
    align-items: center;
    padding: 5px;/*quitar cero*/
    margin: 8px 0;	
}

#propiedades_regla p {
    color: white;
    margin: 0 10px;
    font-weight: bold;
}

 
/*border-radius: 5px;*/
/*
#propiedades_regla .button_property { 
    color: white;
    border: none; 
    padding: 5px 10px;
    cursor: pointer;
    font-size: 14px; 
}
*/

#propiedades_regla .button_property { 
    
    background-color: rgb(25, 25, 25);
    text-shadow: 1px 2px 4px rgba(0,0,0);
    color: white;
    border: 1px solid rgba(255,255,255,0.15);
    padding: 6px 12px;
    cursor: pointer;
    font-size: 14px;
    border-radius: 5px; 
    margin:2px 0;  
    transition: all 0.2s ease;
}

#propiedades_regla .button_property.simulado_activo { 

    background-color: rgb(124, 85, 230);

    border: 1px solid rgba(255,255,255,0.15);
    margin:2px 0; 

    transform: translateY(1px); /* se ve hundido, no elevado */
}




#propiedades_regla .button_property:hover {
    transform: translateY(-2px);
}
 


.linea{position:absolute;height:2px;background:black;pointer-events:none;opacity:.25}
.marcador{position:absolute;width:2px;background:black;transform:translateX(-50%);opacity:.95}
.label-medicion{position:absolute;font-size:15px;color:white;text-align:center;transform:translateX(-50%);background:rgb(48, 48, 48)}

 
/*
.rectangulo-caja{position:absolute;height:50px;background:rgb(0,166,104);transform:translateY(-50%);z-index:9;cursor:grab}
*/
 
.rectangulo-caja {
    position: absolute;
    height: 45px;
    /*background: linear-gradient(135deg, #9874ff 0%, #7c55e6 50%, #532ebd 100%);*/
    background: #7c55e6; 
    transform: translateY(-50%);
    z-index: 9;
    cursor: grab; 
    border-radius: 8px; 
/*
    box-shadow: 
        0 4px 12px rgba(124, 85, 230, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.4),
        inset 0 -2px 0 rgba(0, 0, 0, 0.15); 
 
    border: 1px solid rgba(255, 255, 255, 0.2);
*/
}

/*
.rectangulo-caja:hover {
    background: linear-gradient(135deg, #a794ff 0%, #8b6aea 50%, #623dd5 100%); 
 
    box-shadow: 
        0 6px 16px rgba(124, 85, 230, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.5),
        inset 0 -2px 0 rgba(0, 0, 0, 0.15);
    transform: translateY(-50%);
 
}
*/

.rectangulo-caja:active {
    cursor: grabbing; 
/*
    transform: translateY(-50%);
    box-shadow: 
        0 2px 8px rgba(124, 85, 230, 0.4),
        inset 0 1px 3px rgba(0, 0, 0, 0.2);
*/
}
 




.rectangulo-caja.dragging{cursor:grabbing} 
 
.extremo-blanco {
    position: absolute;
    width: 15px;
    height: 45px;
    background: linear-gradient(135deg, #ffffff 0%, #e8e8e8 100%);
    top: 50%;
    transform: translateY(-50%);
    cursor: ew-resize;
    z-index: 11; 
    box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.extremo-blanco.izquierdo {
    left: -15px; 
    border-radius: 4px 0 0 4px; 
}

.extremo-blanco.derecho {
    right: -15px; 
    border-radius: 0 4px 4px 0; 
}

.extremo-blanco:hover {
    background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
    box-shadow: 
        0 3px 12px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
}


 
 
.boton-mas {
    position: absolute;
    width: 22px;
    height: 22px;
    background: linear-gradient(135deg, #31ffb0 0%, #00e89a 100%);
    color: black;
    border: none;
    border-radius: 50%;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    z-index: 12;
    right: -12px;   
    transform: translate(-50%, calc(-100% - 24px)); /* A√±ade 5px m√°s arriba */
    box-shadow: 
        0 3px 10px rgba(49, 255, 176, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.6),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2); 
    border: 2px solid rgba(255, 255, 255, 0.5);
}
.boton-mas:hover {
    background: linear-gradient(135deg, #4dffbd 0%, #1affaf 100%);
    box-shadow: 
        0 5px 15px rgba(49, 255, 176, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.7),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
    transform: translate(-50%, calc(-100% - 24px)) scale(1.1);
}
.boton-mas:active {
    transform: translate(-50%, calc(-100% - 24px)) scale(0.95);
}












 
@media (max-width: 600px) {
.rectangulo-caja{height:40px}
.extremo-blanco{height:40px}
}
 

@media (max-width: 450px) {
 
    .label-medicion{
       font-size:14px;
    }
}

</style>




<style>
 


/*azul claro 50, 65, 69*/
*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;background-color:rgb(70, 70, 70);min-height:100vh;display:flex;flex-direction:column}#stepPreview{display:none}

 
 
   

.tabs-container{display:flex;background-color:rgb(35,35,35);border:none;align-items:stretch;user-select:none;}
.tabs-add-button{flex:0 0 110px;background-color:transparent;text-shadow: 0 1px 2px rgba(0,0,0);color:#fff;border:none;cursor:pointer;border-right:1px solid rgb(70,70,70);display:flex;align-items:center;justify-content:center;height:40px;padding:0 7px;} 
.tabs-add-button:hover{background-color:#444}
.tabs-add-button .plus {
  font-size: 25px;           /* tama√±o del + */
  line-height: 1;            /* opcional, para centrar vertical */  
}

.tabs-add-button .text {
  font-size: 14px;           /* tama√±o del texto */ 
  white-space: nowrap;
  margin-left: 7px;
}

.tabs-scroll-container{flex:1;display:flex;overflow-x:auto;overflow-y:hidden;white-space:nowrap}.tabs-scroll-container::-webkit-scrollbar{height:6px}.tabs-scroll-container::-webkit-scrollbar-thumb{background-color:#666;border-radius:3px}.tab{padding:10px 15px;background-color:rgb(25, 25, 25);color:#fff;cursor:pointer;border:none;border-right:1px solid #333;font-size:14px;white-space:nowrap;flex-shrink:0;transition:background-color .2s;width:auto}.tab:hover{background-color:#444}.tab.active{background-color:#7c55e6;text-shadow: 0 1px 2px rgba(0,0,0);}.tab-content{flex:1;padding:0px;display:none;align-items:center;justify-content:center;font-size:18px;color:#666}.tab-content.active{display:flex}

#new_project{font-size:12px;padding:0 15px;background-color:transparent;border:none;border-right:1px solid rgb(70,70,70);color:rgb(255,255,255);cursor:pointer;}
#new_project:hover{background-color:#444}

.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1000}.modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background-color:red;padding:20px;border-radius:8px;width:100%; max-height:80vh;overflow-y:auto}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.modal-close{background:0 0;border:none;font-size:24px;cursor:pointer;color:rgb(200,210,220);}.modal-close:hover{color:rgb(255,255,255);}.error-message{background-color:#f44;color:#fff;padding:10px;border-radius:4px;margin-bottom:15px;display:none;text-align:center}.files-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}.file-item{aspect-ratio:1;border:2px dashed #ccc;display:flex;align-items:center;justify-content:center;cursor:pointer;background-color:#f9f9f9;border-radius:8px;position:relative;overflow:hidden}.file-item:hover{border-color:#007bff;background-color:#f0f8ff}.file-item.add-button{font-size:24px;color:#666}.file-preview{width:100%;height:100%;object-fit:cover}.file-name{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.7);color:#fff;padding:2px 4px;font-size:10px;text-align:center}.file-name-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1000}

.modal-content{
  background: rgba(25, 40, 60, 0.55);  
  padding: 20px;
  border-radius: 12px;  
  box-sizing: border-box; 
   color:white;

 
  backdrop-filter: blur(10px) saturate(140%);
  -webkit-backdrop-filter: blur(10px) saturate(140%);

   
  border: 1px solid rgba(255, 255, 255, 0.25);

   
  box-shadow:
    0 0 20px rgba(0, 0, 0, 0.45),
    inset 0 1px 2px rgba(255, 255, 255, 0.2);

   
  background-image: linear-gradient(
    rgba(255,255,255,0.1),
    rgba(0,0,0,0.2)
  );
}



.file-name-form{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:1001;width:90%;max-width:250px;box-sizing:border-box}.file-name-form h3{margin-bottom:10px;color:#333}.file-name-form input{width:100%;padding:8px;margin:10px 0;border:1px solid #ccc;border-radius:4px}.file-name-form button{padding:8px 16px;margin:5px;border:none;border-radius:4px;cursor:pointer}.btn-confirm{background-color:#28a745;color:#fff;}.btn-cancel{background-color:#6c757d;color:#fff;}.hidden{display:none!important}

#file-name-form {
  background: rgba(25, 40, 60, 0.55);  
  padding: 20px;
  border-radius: 12px;  
  box-sizing: border-box; 
   color:white;

 
  backdrop-filter: blur(10px) saturate(140%);
  -webkit-backdrop-filter: blur(10px) saturate(140%);

   
  border: 1px solid rgba(255, 255, 255, 0.25);

   
  box-shadow:
    0 0 20px rgba(0, 0, 0, 0.45),
    inset 0 1px 2px rgba(255, 255, 255, 0.2);

   
  background-image: linear-gradient(
    rgba(255,255,255,0.1),
    rgba(0,0,0,0.2)
  );
}



.plus-modal-overlay-0,.plus-modal-overlay-1 {
    position: fixed;
    inset: 0; /* top:0; right:0; bottom:0; left:0; */
    display: none;
    justify-content: center; /* centro horizontal */
    align-items: center;     /* centro vertical */
    z-index: 9999;
    background: rgba(0,0,0,0.5); /* opcional */
}


 
 
 
 

 
.general-main { 
    display: flex; 
    width: 100%; 
    height: 51vh;  
     
    background-color: transparent; 
    transition: height 0.3s ease;
    overflow: hidden;
    gap:5px;
    padding: 0 10px;
}    

 

/*
.general-1{ 
    flex: 1;  
    display: flex; 
    justify-content: center; 
    align-items: center; 
    background-color: transparent;
    overflow: hidden;
    margin:20px 0; 
} 
*/
.general-1 {
    flex: 1;
    display: flex;
    flex-direction: column; /* uno debajo del otro */
    width: 100%;
    justify-content: center; /* opcional */
    align-items:center; 
    background-color: transparent;
    margin:5px 0px 5px 0px;
    overflow: hidden; 
    border-radius: 10px;
}
 
/*
.buttons-block{
margin:auto 0;
height:40px;
}
*/

 
/*512/320*/
.main-container { 
    display: flex; 
    flex-direction: column; 
    justify-content: flex-start; 
    align-items: center; 
    width: 100%; 
    /*aspect-ratio: 16/9;*/ 
    max-height: 100%;
    height:100%;
    padding:15px; 
    background-color: rgb(48,48,48); 
} 

.video-block {
    position: relative;
    width: 100%;
    flex: 1;
    min-height: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: visible; 
}

 
.wrapper-multimedia { 
    display: flex;
    flex-direction: column;
    align-items: stretch;
    justify-content: center; 
    height: 100%;
    max-height: 100%;
    max-width: 100%; 
    aspect-ratio: 16/9;/*512/320*/
    background-color: transparent;   
} 
 
    

 

 
/*
.video-content {
    flex: 1;
    min-height: 0;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}
*/

.video-block video {
    width: 100%;
    height: 100%;
    aspect-ratio: 16 / 9;
    object-fit: contain;
    background-color: transparent;/*red*/ 
}


 

#video_preview {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    aspect-ratio: 16 / 9;
    background-color: transparent;
    position: relative;  
    overflow: hidden;
}

#liveCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

 
.video-block canvas {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background-color: black; 
} 
 
 
 
 

 










 

 

 


.general-2 { flex: 1; display: flex; justify-content: center; align-items: center; background-color: transparent;margin:5px 0px 5px 0px;padding:0;} 

.second-main-container { width: 100%; height: 100%; background-color: transparent; border-radius: 8px; display: flex; justify-content: center; align-items: center;padding:0;  }

 
.segment_options{ 
    display:none;
    background-color:rgb(48,48,48);
    height: 65px ; 
    justify-content: center;  
    align-items: center;
}
.empty-block-container {
    display: flex;
    box-sizing: border-box;
    flex-direction: column;
    justify-content: flex-start;  
    align-items: center;  
    width: 100%;
    height: calc(var(--empty-block-height, 49vh) - 0px);/*var(--empty-block-height, 49vh);*/  
    background-color: transparent; 
}
.empty-block {
    width: 100%;
    height: 100%; /* ocupa todo el alto del contenedor padre */
    display: flex !important;
    flex-direction: column;
    background-color: transparent;
}


#botones-alineados {
  display: flex; 
  width: 100%;
  overflow-x: hidden;
  text-align: center; /* centra el grupo interno */
}

#grupo-botones {
  display: flex;  /* inline-flex permite centrado con text-align */
  white-space: nowrap;
  width:100%;
}

 

#grupo-botones button {
  flex-shrink: 0;
  height: 40px;
  min-width: 80px; 
  font-size: 14px;  
  text-align: center;
  white-space: normal;
  word-break: break-word;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2px 2px;
  border: 1px solid transparent; 
  color: white;
  background-color: linear-gradient(135deg, #8b6ce8 0%, #6a4bc9 100%);
  cursor: pointer;
  margin: 5px 0px; 
  line-height: 1;  
  font-weight: 500;
}

#grupo-botones button:hover { 
  border: 1px solid rgba(255, 255, 255, 0.3);
}
 









.custom-dropdown {
    position: relative;
    width: 100%; ¬¥ 
    margin-top: 15px;	
    margin-bottom: 5px;
    cursor: pointer;
    color:rgb(0,0,0);
}

.dropdown-selected {
    padding: 4px;
    background: #eee;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.dropdown-options {
    position: absolute;
    bottom: 100%;        /* üëà hace que se abra hacia ARRIBA */
    left: 0;
    width: 70%;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    display: none;       /* oculto por defecto */
    list-style: none;
    padding: 0;
    margin: 0 0 5px 0;   /* un peque√±o espacio hacia arriba */
    z-index: 999;
}

.dropdown-options li {
    padding: 4px;
    cursor: pointer;
}

.dropdown-options li:hover {
    background: #eee;
}

 


 

#modal_overlay_dinamico {
  position: fixed;
  inset: 0;  
  display: none;
  align-items: center;
  justify-content: center; 
  overflow: auto;
  box-sizing: border-box;
  background-color: rgb(20,20,20,0.6); 
  backdrop-filter: blur(2px); 
}
 
#modal_box_dinamico {  
  padding: 20px;
  border-radius: 12px;
  display: inline-block;
  max-width: 90%;
  box-sizing: border-box; 
  color:white;
   
 
  border: 1px solid rgba(255, 255, 255, 0.45);
  
   
  backdrop-filter: blur(10px);
  background-color: rgb(40,40,40);/*#1e4b82 #3e18a3*/
}
 
 






.dropdown_selector option {
  background: rgba(20, 35, 55, 0.85);
  color: #e8f4ff;
  padding: 10px;
  font-size: 14px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}

/* Profundidad al abrir el men√∫ */
.dropdown_selector:focus option {
  background: rgba(22, 40, 60, 0.9);
}

/* Efecto de iluminaci√≥n al pasar el cursor */
.dropdown_selector option:hover {
  background: rgba(80, 140, 200, 0.85);
  color: white;
}

/* Opci√≥n seleccionada en el men√∫ */
.dropdown_selector option:checked {
  background: rgba(120, 180, 255, 0.85);
  color: #0b1a2f;
  font-weight: bold;
}






#general-0 {
    display: flex;
    flex-direction: column;
    align-items: center;          /* centrar horizontalmente */
    justify-content: center;      /* centrar verticalmente */
    margin: 20px 40px;
    height: auto;
    width: max-content;
    gap: 10px;
    user-select: none;            /* evitar selecci√≥n de texto */
}

.seccion-cuadrada {
    width: 50px;
    height: 50px;
    background-color: rgb(196, 205, 208);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    color: white;
    /*border: 1px solid rgb(25, 25, 25);*/
    border-radius: 5px;
    position: relative;           /* necesario para el tooltip */
    cursor: pointer; 
    box-shadow:
    0 0 0 1px rgba(255, 255, 255, 0.6),
    0 0 12px 2px rgba(255, 255, 255, 0.4); 
 
}
 
 
.tooltip {
    position: absolute;
    left: 100%;                   /* a la derecha del cuadrado */
    top: 50%;
    transform: translateY(-50%);
    background-color: white;
    color: black;
    padding: 5px;
    margin-left: 10px;             /* separaci√≥n del cuadrado */
    white-space: nowrap;           /* evitar que se corte el texto */
    display: none;                /* se muestra al hover */
    font-size: 14px;
    border-radius: 3px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    z-index:4;	
}

 
@media (max-width: 1150px) { 
    #user-menu{
	display:none;
    }
}
  
@media (max-width: 1000px) {

    body{background-color:rgb(35, 45, 50)}

    #general-header{display:block} 

    .plus-modal-header {  
    	display:flex;  
    }


    #general-0 { 
    	display:none; 
    }
	
    .general-main {
        flex-direction: row; /*column*/         
        height: auto;   
	min-height:auto;              
    }
 
    .general-1{   
        margin: 30px 0;
        padding: 0;
        height: auto; 
    }   
    
    .general-2{
        display: none;
    }
 
    .main-container {
        width: 100%;
        max-width: 500px;  
        padding: 0;
        height: auto;  
    }
    .empty-block-container{ 
        height: calc(100vh - var(--altura-general-main));  
    }	
    
    .second-main-container {
        width: 100%;
        height: auto;
    }
    
    .video-block {
        height: auto;  
        flex: none; 
    }
 
 
    .wrapper-multimedia { 
        height: auto;
        width: 100%;
        max-width: 100%;
        aspect-ratio: 16/9;/*512/320*/ 
    } 
    
    .video-content {
        aspect-ratio: 16 / 9;
    }
    
    .second-main-container.plus-modal-content-0 {
        margin: 5px 0;	
	max-height: 100%;
    }
    .second-main-container.plus-modal-content-1 {
        margin: 5px 0;	
	max-height: 100%;
    }

    .plus-modal-content-0,.plus-modal-content-1 { 
        max-width:400px;
	max-height: 1000px;
    }
 
    
 
    
    .plus-modal-title-0,.plus-modal-title-1{
        font-size: 14px;
    }

    .plus-modal-close-0,plus-modal-close-1 {
    	display:flex; 
    } 
    #grupo-botones button{
    	margin: 5px 0px;
    }
    #grupo-botones button:hover {
    	transform: none;
    }
    #propiedades_regla .button_property:hover{
	transform: none;
    } 
    .tab-button-active-settings,
    .tab-button-inactive-settings { 
    font-size: 14px; 
    }

    .plus-modal-header-0,.plus-modal-header-1 {  
    	display:flex; 
    }
}

 
@media (max-width: 540px){

    .general-main { 
    	padding: 0;
    }  

    .plus-modal-content-0,.plus-modal-content-1 { 
    	height: calc(100vh - 240px); 
    }

    .general-1{   
        margin: 0;
        padding: 0;
        height: auto; 
    }  
    .general-1 { 
    	border-radius: 0;
    }

    #general-0 { 
    	margin: auto 20px; 
    }

    .seccion-cuadrada {
    	width: 50px;
    	height: 50px;  
    }
} 

@media (max-width: 450px) { 
 
     
      
    .video-block video { 
    	border-radius: 0;
    }
 
    .wrapper-multimedia {
        aspect-ratio: 16 / 9; /* Solo el video, sin altura de botones */
    }
    
 

    #grupo-botones button { 
  	font-size:12px;   
    } 

    .detail-box { 
  	flex-direction: column; 
    } 
 
   .empty-block-container { 
    	justify-content: flex-start;  
    }

    .tabs-add-button{
	flex:0 0 110px;/*40*/
    } 


}

/*
@media (max-width: 320px) {
    #grupo-botones button { 
        height: 35px;
  	font-size:11px;  
    }
} 
*/

#item-loader{
display:none;
}

#liveCanvas{
	background-color: transparent; 
} 
 

  
.overlay_regla {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;             /* ocupa lo mismo que el scroll-wrapper */
    height: 100%;
    pointer-events: none;    /* no bloquea el scroll */
    z-index: 2;             /* se muestra por encima */
}

 
#add-file-btn{
    font-size:40px;
}

#cancel_task{display:flex;align-items:center;gap:10px}
#cancel_task button{display:flex;color:#fff;font-size:16px;background-color:#004ad3;align-items:center;justify-content:center;border:none;margin:0;border-radius:4px;padding:8px 10px;cursor:pointer}
#cancel_task p{display:flex;color:rgb(255,255,255);font-size:16px;margin:2px;padding:0}

#marcadores_fijos {
    position: relative; 
    height: 40px;
    width: 100%;
    background-color: transparent;
    box-sizing: border-box;
    overflow: hidden;  
    user-select: none;
}
 
.icon {
  display: flex;
  flex-direction: column; /* organiza SVG y texto en columna */
  justify-content: space-between; /* separa filas arriba y abajo */
  align-items: center; /* centra horizontalmente cada fila */
  height: 100%; /* opcional: que ocupe todo el contenedor padre */
}

.icon svg {
  display: block; /* elimina espacio inline */
  margin: 0 auto; /* centra horizontalmente */
}

.icon .label {
  text-align: center; /* centra texto horizontal */
}









/*add file*/
 
 


.btn-close{
  position: absolute;
  top: -10px;
  right: -10px;
  width: 34px;
  height: 34px;
  font-size:29px;
  border-radius: 50%;
  border: none;
  background: #fff;
  display: grid;
  place-items: center;
  cursor: pointer;
  box-shadow: 0 6px 14px rgba(0,0,0,.25);
  transition: transform .2s;
}
.btn-close:hover{ transform: scale(1.05); }

.btn-close button{
   font-size:29px;
}
.actions{
  display: flex; 
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center; 
  align-items: center;  
}

.btn-confirm{
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.25);
  background: rgba(255,255,255,0.1);
  color: #fff;
  font-size: 16px;
  letter-spacing: .4px;
  cursor: pointer;
  transition: .25s;
  backdrop-filter: blur(6px);
}

.btn-confirm svg{
  flex-shrink: 0;
}

.btn-confirm:hover{
  transform: translateY(-2px);
  background: rgba(255,255,255,.18);
  box-shadow: 0 10px 18px rgba(0,0,0,.25);
}

#my-video-2{
display:none;
}
 
#canvas{
aspect-ratio: 16/9;
}

 

 

#buttons-block {
    background-color: rgb(48, 48, 48);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 5px;
    border-radius: 8px;
    gap: 20px;
    position: relative;
    width:100%;
}

#timeline-container,
#controls,
#fullscreen-container {
    background-color: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
}

/*
#controls {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}
*/

#timestamp {
    color: #e0e0e0;
    font-family: 'Courier New', monospace;
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
    user-select: none;
}

#play,
#pause,
#fullscreen-btn {
    background-color: transparent;
    border: none;
    cursor: pointer;
    padding: 4px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
}

#play svg,
#pause svg,
#fullscreen-btn svg {
    width: 28px;
    height: 28px;
    fill: #e0e0e0;
}


#rewind,
#forward {
    background-color: transparent;
    border: none;
    cursor: pointer;
    padding: 4px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
}

#rewind svg,
#forward svg {
    width: 28px;
    height: 28px;
    fill: #e0e0e0;
}

#controls {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 8px;
}

#undo-redo-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin:0 5px;
}

#undo,
#redo {
    background-color: transparent;
    border: none;
    cursor: pointer;
    padding: 4px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
}

#undo svg,
#redo svg {
    width: 24px;
    height: 24px;
    fill: #e0e0e0;
}



#zoom-out{
    background-color: transparent;
    border: none;
    cursor: pointer;
    padding: 4px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
}
#zoom-in {
    background-color: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    margin: 0 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
}

#zoom-out svg {
    width: 28px;
    height: 28px;
    fill: #e0e0e0;
}

#zoom-in svg {
    width: 35px;
    height: 35px;
    fill: #e0e0e0;
}



  #progress {
    height: 100%;
    background: blue;
    width: 0%;
    border-radius: 5px;
  }

  #handle {
    position: absolute;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: white;
    border: 2px solid blue;
    top: 50%;
    transform: translate(-50%, -50%);
    left: 0%;
    cursor: pointer;
  } 


/* Para navegadores Chromium (Chrome, Edge, Opera) y Safari */
.empty-block-container::-webkit-scrollbar {
    background-color: rgb(48, 48, 48);
}

.empty-block-container::-webkit-scrollbar-thumb {
    background-color: white;
    border-radius: 10px;
}

.empty-block-container::-webkit-scrollbar-thumb:hover {
    background-color: #e0e0e0;
}

/* Para Firefox */
.empty-block-container {
    scrollbar-color: white rgb(48, 48, 48);
}


</style> 


</head>
<body>

 
    
<div class="general-wrapper">

 

<div class="general-main"> 
  <div id="user-menu" class="general-2">
    <div class="second-main-container">  
    </div>
  </div> 
  <div class="general-1">
    <div class="main-container"> 
        <div id="stepVideoTag" class="video-block">
            <div id="stepVideoTagContent" class="wrapper-multimedia">
                <div class="video-content">
                    <video id="my-video-2" controls>
                        <source src="" type="video/mp4">
                        Tu navegador no soporta el elemento video.
                    </video> 
 
  		    <canvas id="canvas"></canvas>

   
 			
                </div>  
            </div> 
        </div>

        <div id="stepPreview" class="video-block">    
            <div id="stepPreviewContent" class="wrapper-multimedia">
                <div class="video-content">
                    <div id="video_preview">
                        <canvas id="liveCanvas"></canvas>
                        <p id="preview_description"></p>
                    </div> 
                </div> 
            </div>
        </div>
	 
               	 
<div class="buttons-block" id="buttons-block">
    <div id="timeline-container">
        <div id="timeline" style="display:none;">
            <div id="progress"></div>
            <div id="handle"></div>
        </div>
        <div id="timestamp">00:00:00</div>
        <div id="undo-redo-container" style="display:none;">
            <button id="undo">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/>
                </svg>
            </button>
            <button id="redo">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/>
                </svg>
            </button>
        </div>
    </div>
    <div id="controls">
        <button id="rewind">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/>
            </svg>
        </button>
        <button id="play">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 5v14l11-7z"/>
            </svg>
        </button>
        <button id="pause" style="display:none;">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
        </button>
        <button id="forward">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/>
            </svg>
        </button>
    </div>
    <div id="fullscreen-container">
	<button id="zoom-out" style="display:none;">
            <svg xmlns="http://www.w3.org/2000/svg"
     width="35" height="35" viewBox="0 0 24 24">
  <!-- Rombo centrado -->
  <path
    d="M12 5 L19 12 L12 19 L5 12 Z"
    fill="#e0e0e0"
  />
  <!-- Signo + ligeramente m√°s largo -->
  <path
    d="M4 0v8M0 4h8"
    stroke="#e0e0e0"
    stroke-width="2"
    fill="none"
  />
</svg>
        </button>
        <button id="zoom-in" style="display:none;">
            <svg viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
  <path fill="#e0e0e0" d="
    M7.875 21.25 
    L11.625 9.25 
    H13.875 
    L17.625 21.25 
    H15.25 
    L14.375 18.5 
    H10.625 
    L9.75 21.25 
    Z

    M11.25 17.25 
    H13.75 
    L12.5 12.75 
    Z

    M18.75 9.25 
    H23.625 
    V12 
    H22.125 
    V19.25 
    H23.625 
    V21.25 
    H18.75 
    V19.25 
    H20.25 
    V12 
    H18.75 
    Z
  "/>
</svg>

        </button>
        <button id="fullscreen-btn">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            </svg>
        </button>
    </div>
</div>
	 
    </div> 
  </div>
  <div class="general-2">
    <div class="second-main-container">  
    </div>
  </div>		
</div>

	<div id="item-loader">
		<div class="tab-loader" style="margin-top: 70px; margin-bottom: 70px;">
		    <div class="donut"></div>
		    <p id="loader-text" style="color: #ffffff; text-align: center; margin-top: 20px; font-size: 18px;"> 
			Loading item...
		    </p>
		 </div>
	</div>
    <div class="empty-block-container">
	 

        <div class="empty-block"> 
            <div class="tabs-container" id="tabs-container">
		<button id="new_project" style="display:none;">New<br>Project</button>


                <button class="tabs-add-button" id="create_item">
		  <span class="plus">+</span>
		  <span class="text">Add file</span>
		</button>
		<button class="tabs-add-button" id="change_view" style="display:none;width:200px;"> 
			Change view 
		</button>
		<button class="tabs-add-button" id="export_video" style="display:none;background-color:#7c55e6;"> 
			Export 
		</button>
		<button class="tabs-add-button" id="principal_view" style="display:none;align-items:center;"> 
<span class="plus">
			<svg width="19.2" height="19.2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M11 19L4 12L11 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
</svg>
</span>
<span class="text">Principal view</span>  
		</button>

<!--
<button id="upload-btn" translate="no">Upload (aparecera despues de seleccionar el tipo de archivo)</button>
-->
<button id="upload-btn" style="display:none;">Upload</button>
<!--
		<button class="tabs-add-button" id="finish-btn" translate="no">
		  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
		    <polyline points="23 4 23 10 17 10"></polyline>
		    <polyline points="1 20 1 14 7 14"></polyline>
		    <path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"></path>
		    <path d="M20.49 15a9 9 0 0 1-14.13 3.36L1 14"></path>
		  </svg>
		  <span class="text">Update video</span>
		</button>
-->
                <button class="tabs-add-button" id="update" style="display:none;" translate="no">Update frames</button> 
		<button class="tabs-add-button" id="plus-btn" translate="no">Shortcuts</button>
                <div class="tabs-scroll-container" id="tabs-scroll-container">
                </div>
            </div>
            <div id="tab-contents">

		<div id="subcontent-regla">  
                         
			  
			 <div id="marcadores_fijos"></div>  
			<div class="scroll-wrapper"> 
				<div class="contenedor" id="contenedor"></div> 
			</div> 
			<div id="overlay_regla" class="overlay_regla"> 
					<!--  
					<div id="overlay_flecha" style="position:absolute; top:20px; left:29px; font-size:20px;color:rgb(196, 205, 208);">
        					‚ñº
    					</div>
					-->
					<div id="overlay_flecha"
					     style="
					        position:absolute;
					        top:24px; 
					        left:34px; 
					        width:11px; 
					        height:18px; 
					        background-color:rgb(255, 255, 255);
					        border-radius:5px; 
					     ">
					</div>
					<div style="
        					position:absolute;
        					top:29px;        
        					left:39px; 
        					width:1px;       
        					height:calc(100% - 29px);    
        					background-color:rgb(255, 255, 255);
    					"></div>
		 	</div>
			 
		</div> 

            </div>
        </div>
    </div>
    <div id="segment_options" class="segment_options"> 
				<div id="botones-alineados">
				  <div id="grupo-botones">
				     <button style="display:none"></button>
				    <button style="display:none"></button>
				    <button style="display:none"></button>
				    <button style="display:none"></button>
				    <button style="display:none"></button>
				    <button style="display:none"></button>
				    <button style="display:none"></button>
				    <button style="display:none"></button>
				    <button style="display:none"></button>
				    <button style="display:none"></button>
				  </div>
				</div>
    </div>

</div><!--wrapper-->

<div id="modal_overlay_dinamico">
  <div id="modal_box_dinamico"> 
  </div>
</div>


    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <p style="font-size:18px;font-weight:bold;">Upload files</p>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
             
            <div class="files-grid" id="files-grid">
                <div class="file-item add-button" id="add-file-btn">+</div>
            </div>
        </div>
    </div>


 
 
 




 
<!--
<div class="plus-modal-overlay" id="plus-modal-overlay">
  <div class="plus-modal-content">
    <div class="plus-modal-header">
      <p class="plus-modal-title">Advanced</p>
      <button class="plus-modal-close" id="plus-modal-close">&times;</button>
    </div>
    <div class="tabs-menu-container-settings">
      <button class="tab-button-active-settings" data-tab="general-tab-content-settings" translate="no">General</button>
      <button class="tab-button-inactive-settings" data-tab="advanced-tab-content-settings" translate="no">Comments</button>
      <button class="tab-button-inactive-settings" data-tab="team-tab-content-settings" translate="no">Teams</button>
    </div>
    <div id="different_tabs"></div>  
  </div> 
</div>
--> 



<!-- PRIMER BLOQUE - Para el primer .second-main-container -->
<div class="plus-modal-overlay-0" id="plus-modal-overlay-0">
  <div class="plus-modal-content-0">
    <div class="plus-modal-header-0">
      <p class="plus-modal-title-0">Advanced</p>
      <button class="plus-modal-close-0" id="plus-modal-close-0">&times;</button>
    </div>
    <div class="tabs-menu-container-settings-0">
      <button class="tab-button-active-settings-0" data-tab="general-tab-content-settings-0" translate="no">Profile</button>
      <button class="tab-button-inactive-settings-0" data-tab="advanced-tab-content-settings-0" translate="no">Projects</button>
      <button class="tab-button-inactive-settings-0" data-tab="team-tab-content-settings-0" translate="no">Tutorials</button>
      <button class="tab-button-inactive-settings-0" data-tab="upgrade-tab-content-settings-0" translate="no"></button>
    </div>
    <div id="different_tabs_0"></div>  
  </div> 
</div>

<!-- SEGUNDO BLOQUE - Para el segundo .second-main-container -->
<div class="plus-modal-overlay-1" id="plus-modal-overlay-1">
  <div class="plus-modal-content-1">
    <div class="plus-modal-header-1">
      <p class="plus-modal-title-1">Advanced</p>
      <button class="plus-modal-close-1" id="plus-modal-close-1">&times;</button>
    </div>
    <div class="tabs-menu-container-settings-1">
      <button class="tab-button-active-settings-1" data-tab="general-tab-content-settings-1" translate="no">General</button>
      <button class="tab-button-inactive-settings-1" data-tab="advanced-tab-content-settings-1" translate="no">Comments</button>
      <button class="tab-button-inactive-settings-1" data-tab="team-tab-content-settings-1" translate="no">Teams</button>
    </div>
    <div id="different_tabs_1"></div>  
  </div> 
</div>


 
 
 

<!-- Modal de error (fondo rojo) -->
<div class="error-modal-overlay" id="error-modal-overlay">
    <div class="error-modal-content">
        <div class="error-modal-header">
            <button class="error-modal-close" id="error-modal-close">&times;</button>
        </div>
        <p class="error-modal-message" id="error-modal-message"></p>
    </div>
</div>

<!-- Modal de confirmaci√≥n -->
<div class="confirm-modal-overlay" id="confirm-modal-overlay">
    <div class="confirm-modal-content">
        <div class="confirm-modal-header">
            <h3>Confirmar</h3>
            <button class="confirm-modal-close" id="confirm-modal-close">&times;</button>
        </div>
        <p class="confirm-modal-message">¬øRealmente quieres finalizar?</p>
        <div class="confirm-modal-buttons">
            <button class="confirm-btn-yes" id="confirm-btn-yes">Yes</button>
            <button class="confirm-btn-no" id="confirm-btn-no">No</button>
        </div>
    </div>
</div>
 
    <input type="file" id="file-input" accept="image/*,video/*,audio/*" multiple style="display: none;">


<script>

function generateRandomUserId() {
    const digits = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let userId = "";
    for (let i = 0; i < 10; i++) {
      const randomIndex = Math.floor(Math.random() * digits.length);
      userId += digits[randomIndex];
    }
    return userId;
}

let userId = localStorage.getItem("useridManycaptions");
//userId = "0123456789";
  
  if (!userId) {
    userId = generateRandomUserId();
    localStorage.setItem("useridManycaptions", userId);
  }
 
let current_scroll_x = 0;
let current_filetype="scene";
let current_filename;
let selected_rect;
let current_box_options = [];
 
let box_options = ["Delete_box"];

let current_timeline = [[],[],[],[]];
const initial_configuration = {"properties_with_keyframes":["scale","rotation","opacity","position", "camera_position","camera_zoom"],
				"properties_with_predefined_values":{"item_reveal":["show","hide","off"],"background_remove":["off","on"]}};
 
  




//quitar
 

function adaptPlusSection() {
  const plusBtn = document.getElementById('plus-btn');
  const plusModalOverlay0 = document.getElementById('plus-modal-overlay-0');
  const plusModalOverlay1 = document.getElementById('plus-modal-overlay-1');
  const secondMainContainers = document.querySelectorAll('.second-main-container');
  const plusContent0 = document.querySelector('.plus-modal-content-0');
  const plusContent1 = document.querySelector('.plus-modal-content-1');
  
  if (window.innerWidth > 1000) {
    // ----- MODO ESCRITORIO -----
    if (plusBtn) plusBtn.style.display = 'none';
    if (plusModalOverlay0) plusModalOverlay0.style.display = 'none';
    if (plusModalOverlay1) plusModalOverlay1.style.display = 'none';
    
    // Primer contenedor con plusContent0
    if (secondMainContainers[0] && plusContent0) {
      secondMainContainers[0].innerHTML = '';
      secondMainContainers[0].appendChild(plusContent0);
      plusContent0.style.display = 'flex';
      plusContent0.style.flexDirection = 'column';
      plusContent0.style.width = '100%';
      plusContent0.style.height = '100%';
    }
    
    // Segundo contenedor con plusContent1
    if (secondMainContainers[1] && plusContent1) {
      secondMainContainers[1].innerHTML = '';
      secondMainContainers[1].appendChild(plusContent1);
      plusContent1.style.display = 'flex';
      plusContent1.style.flexDirection = 'column';
      plusContent1.style.width = '100%';
      plusContent1.style.height = '100%'; 
    }
  } else {
    // ----- MODO MOBILE -----
    if (plusBtn) plusBtn.style.display = 'none';//block pendiente
    
    // Solo mover plusContent1 al modal overlay en mobile
    if (plusContent1 && plusModalOverlay1 && !plusModalOverlay1.contains(plusContent1)) {
      plusModalOverlay1.appendChild(plusContent1);
    }
    
    // Ocultar plusContent0 en mobile
    if (plusContent0) {
      plusContent0.style.display = 'none';
    }
    
    // Reset estilos de plusContent1
    if (plusContent1) {
      plusContent1.style.display = '';
      plusContent1.style.flexDirection = '';
      plusContent1.style.width = '';
      plusContent1.style.height = '';
      plusContent1.style.boxShadow = '';
    }
  }
}


function adaptPlusSection_0() {
  const plusBtn = document.getElementById('plus-btn');
  const plusModalContent = document.querySelector('.plus-modal-content');
  //const secondMainContainer = document.querySelector('.second-main-container');
  const secondMainContainers = document.querySelectorAll('.second-main-container');
  const plusModalOverlay = document.getElementById('plus-modal-overlay');

  if (window.innerWidth > 1000) {
    // --- MODO ESCRITORIO ---
    plusBtn.style.display = 'none';
    plusModalOverlay.style.display = 'none'; // cerrar modal si estaba abierto
/*
    // Verifica si ya no est√° insertado
    if (!secondMainContainer.querySelector('.plus-modal-content')) {
      // Mueve el contenido del modal al panel derecho
      secondMainContainer.innerHTML = ''; // limpia
      secondMainContainer.appendChild(plusModalContent);
 
      plusModalContent.style.display = 'flex';
      plusModalContent.style.flexDirection = 'column';
      plusModalContent.style.width = '100%';
      plusModalContent.style.height = '100%';
 
      plusModalContent.style.boxShadow = '0 0 0 1px rgba(20, 20, 20, 0.6), 0 0 20px 4px rgba(0, 0, 0, 0.5)';
    }
*/
    secondMainContainers.forEach(container => {
  if (!container.querySelector('.plus-modal-content')) {
    container.innerHTML = '';

    const clone = plusModalContent.cloneNode(true);
    container.appendChild(clone);

    clone.style.display = 'flex';
    clone.style.flexDirection = 'column';
    clone.style.width = '100%';
    clone.style.height = '100%';
    //clone.style.boxShadow = '0 0 0 1px rgba(20, 20, 20, 0.6), 0 0 20px 4px rgba(0, 0, 0, 0.5)';
  }
});

  } else {
    // --- MODO MOBILE ---
    plusBtn.style.display = 'block';

    // Si el contenido est√° dentro del panel derecho, lo devolvemos al modal
    const modalInner = document.querySelector('.plus-modal-overlay');
    if (!modalInner.querySelector('.plus-modal-content')) {
      modalInner.appendChild(plusModalContent);
      plusModalContent.style = 'flex'; // restablece estilos 
       
	
    }
  }
}
 
  
window.addEventListener('resize', adaptPlusSection);
window.addEventListener('load', adaptPlusSection);
</script>

<script>

let websocketClient;
let filenames_llenos = 0;
let textnames_llenos = 0;
let valores_predefinidos = [1];
let current_item = "scene";
let current_property_id = "";

// AGREGAR estas constantes al inicio con las dem√°s
const errorModalOverlay = document.getElementById('error-modal-overlay');
const errorModalClose = document.getElementById('error-modal-close');
const errorModalMessage = document.getElementById('error-modal-message');
const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
const confirmModalClose = document.getElementById('confirm-modal-close');
const confirmBtnYes = document.getElementById('confirm-btn-yes');
const confirmBtnNo = document.getElementById('confirm-btn-no');

// AGREGAR funci√≥n para mostrar modal de error
function showErrorModal(message) {
    errorModalMessage.textContent = message;
    errorModalOverlay.style.display = 'block';
}

// AGREGAR funci√≥n check_conditions
function check_conditions() {
    // Verificar si se ha subido al menos un archivo
    if (uniqueFiles.length === 0 && textnames_llenos==0) {
        showErrorModal('No multimedia files have been uploaded yet');
        return false;
    }
    
    // Verificar si se ha creado al menos un tab
    if (customNames.length <= 1) {
        showErrorModal('No tabs have been created yet. Press "+" to create one.');
        return false;
    }
    
    // Verificar si valores_predefinidos est√° vac√≠a
    if (filenames_llenos==0 && textnames_llenos==0) {//valores_predefinidos.length === 0
	//La lista "valores_predefinidos" esta vacia
        showErrorModal('"filename" property has no keyframe value. Assign it a value.');
        return false;
    }
    
    return true;
}

// AGREGAR eventos para cerrar modal de error
errorModalClose.addEventListener('click', () => {
    errorModalOverlay.style.display = 'none';
});

errorModalOverlay.addEventListener('click', (e) => {
    if (e.target === errorModalOverlay) {
        errorModalOverlay.style.display = 'none';
    }
});

// AGREGAR eventos para modal de confirmaci√≥n
confirmModalClose.addEventListener('click', () => {
    confirmModalOverlay.style.display = 'none';
});

confirmModalOverlay.addEventListener('click', (e) => {
    if (e.target === confirmModalOverlay) {
        confirmModalOverlay.style.display = 'none';
    }
});

confirmBtnNo.addEventListener('click', () => {
    confirmModalOverlay.style.display = 'none';
});

confirmBtnYes.addEventListener('click', () => {
    confirmModalOverlay.style.display = 'none';
    // Aqu√≠ se ejecutan las acciones del finish
    show_stepPreview();
    console.log('Acci√≥n realizada: Bot√≥n FINISH presionado');
    console.log('Estado actual de la aplicaci√≥n:', {
        archivosSubidos: uploadedFiles.length
    });
    equilibrar_rectangulos();
    const items_with_audio = extraerListasComoString(item_types, ["video","audio"], "/separator/");	
    console.log("items_with_audio: ",items_with_audio);
    const json_data = {"service":"update_video","itemName":current_timeline[3],"property":current_timeline[2],"params":"empty","items_with_audio":items_with_audio,"extra0":"","extra":""}; 
    websocketClient.send(JSON.stringify(json_data));
    crear_loading_tab(); 
    finalizar(); 
});


function ocultarPendientesYErrores() {
  const ids = ["error_subidas_pendientes", "pendientes_de_subir"];

  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = "none";
    }
  });
}


 

function request_render_0(){
    closeModalDinamico();
    // Aqu√≠ se ejecutan las acciones del finish
    show_stepPreview();
    console.log('Acci√≥n realizada: Bot√≥n FINISH presionado');
    console.log('Estado actual de la aplicaci√≥n:', {
        archivosSubidos: uploadedFiles.length
    });
    equilibrar_rectangulos();
    const items_with_audio = extraerListasComoString(item_types, ["video","audio"], "/separator/");	
    console.log("items_with_audio: ",items_with_audio);
    const json_data = {"service":"update_video","itemName":current_timeline[3],"property":current_timeline[2],"params":"empty","items_with_audio":items_with_audio,"extra0":"","extra":""}; 
    websocketClient.send(JSON.stringify(json_data));
    crear_loading_tab(); 
    finalizar();  
}

function renderPendientes(diccionario) {
  const ul = document.getElementById("pendientes_de_subir");
  if (!ul){return;}	
  ul.style.display="block";
  // opcional: limpiar antes
  ul.innerHTML = "";

  if (Object.keys(progress_visible_names).length == uploaded_names.length){
	ocultarPendientesYErrores();
  }		

  Object.keys(diccionario).forEach(key => {
    const value = diccionario[key]; // siempre string
    if (key!=value){	 
	console.log("key:",key,", value:",value);

    	const li = document.createElement("li");
    	li.textContent = value;
    	li.style.padding = "6px 4px";
    	li.style.borderBottom = "1px solid rgba(255,255,255,0.15)";

    	ul.appendChild(li);
    }	
  });
}

 
function extraerListasComoString(dic, claves, separator) {
  const resultado = [];

  for (const clave of claves) {
    if (Array.isArray(dic[clave])) {
      resultado.push(...dic[clave]);
    }
  }

  return resultado.join(separator);
}



        let uploadedFiles = {};
        let customNames = [];
        let file_types = {
            "image": [],
            "video": [],
            "audio": [],
	    "text": []	
        };

	//almacena el nombre de los items, no de los files
	let item_types = {
            "image": [],
            "video": [],
            "audio": []
        };

        const uploadBtn = document.getElementById('upload-btn');
        const finishBtn = document.getElementById('finish-btn');
        const plusBtn = document.getElementById('plus-btn');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalClose = document.getElementById('modal-close'); 
        const filesGrid = document.getElementById('files-grid');
        const addFileBtn = document.getElementById('add-file-btn');
        const fileInput = document.getElementById('file-input'); 
        const tabsScrollContainer = document.getElementById('tabs-scroll-container');
        const tabContents = document.getElementById('tab-contents'); 
        const plusModalOverlay = document.getElementById('plus-modal-overlay-1');
        const plusModalClose = document.getElementById('plus-modal-close-1'); 
    

	const newProjectButton = document.getElementById('new_project'); 

	let selectedOption_item = null;
 

         

        function isNameTaken(name) {
            return customNames.includes(name);
        }

        function truncateTabName(name) {
            if (name.length <= 16) {
                return name;
            }
            return name.substring(0, 10) + name.substring(name.length - 6);
        }

function limpiarEspaciosYReemplazar(texto) { 
    let limpio = texto.trim().replace(/\s+/g, ' '); 
    limpio = limpio.replace(/ /g, '_'); 
    return limpio;
}
function limpiarEspacios(texto) { 
    let limpio = texto.trim().replace(/\s+/g, ' ');  
    return limpio;
}

        function createTab(name) { 

		name = limpiarEspaciosYReemplazar(name);
 
  		const tab = document.createElement('div');
                tab.className = 'tab';
                tab.dataset.tabName = name;
                tab.textContent = name;

                const content = document.createElement('div');
                content.className = 'tab-content';
                content.dataset.tabName = name;
                 
 
		let current_params = "empty"; 
		if (selectedOption_item){
			current_params = "filetype="+selectedOption_item;
		}
		const json_data = {"service":"change_item_view","itemName":name,"property":"empty","params":current_params,"file_type":selectedOption_item,"resolution":resolution_scene,"extra0":"0","extra":"0"}; 
 	
		 
		current_item = name; 
		console.log("MAL: ",name);

                tab.addEventListener('click', (e) => {
 
		    timestamp_and_duration=null;	

		    if (tab.classList.contains('active')) {
        		return;
    		    }

const modo = e.currentTarget.dataset.modo;
if (modo != 'delete_item') {
console.log("MAL: ",current_item);
const json_data_02 =  {"service":"save_item_data","itemName":current_item,"property":current_property_id,"params":"time="+current_scroll_x, "rectangulos":unica_regla.rectangulos,"extra":"change1"}; 
websocketClient.send(JSON.stringify(json_data_02)); 
}
 
	
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    content.classList.add('active');
		    current_item = name;
			 
 

                     
 	
		    websocketClient.send(JSON.stringify(json_data));
			crear_loading_tab(); 
			finalizar(); 
			
			show_vertical_line(); 
			 	
 	
                }); 
 
		if (isNameTaken(name)) {
			return;
		}else{
			customNames.push(name);
                	console.log('Nombre personalizado agregado:', name); 
			if (name!="scene"){
				current_property_id = "filename";//pendiente (no siempre sera asi)
			}
		} 


		 
 
		 

                      
		websocketClient.send(JSON.stringify(json_data));  
		crear_loading_tab();	
		finalizar();

                tabsScrollContainer.appendChild(tab);
                tabContents.appendChild(content);

                // Activar el nuevo tab autom√°ticamente al crearlo
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                content.classList.add('active');

 
 
	
 
        }

        uploadBtn.addEventListener('click', () => {
            console.log('Acci√≥n realizada: Bot√≥n UPLOAD presionado');
            modalOverlay.style.display = 'block';
        });

	  

	/* 
	finishBtn.addEventListener('click', () => {
		console.log("uploadedFiles: ",uniqueFiles.length);
		if (check_conditions()) { 
    			abrirModalDinamicoSimple(html_finish);
			renderPendientes(progress_visible_names);
		}
	});
	*/

        plusBtn.addEventListener('click', () => {
            console.log('Acci√≥n realizada: Bot√≥n + presionado');
	    //insertarPlusModalContent("plus-modal-overlay");	
            plusModalOverlay.style.display = 'flex';
        });
 
 

	newProjectButton.addEventListener('click', () => {
            console.log('Acci√≥n realizada: New Project'); 
		abrirModalDinamicoSimple(html_new_project);
        });

        plusModalClose.addEventListener('click', () => { 
            plusModalOverlay.style.display = 'none';  
        });
 
 

        modalClose.addEventListener('click', () => {
            modalOverlay.style.display = 'none'; 
        });

        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                modalOverlay.style.display = 'none'; 
            }
        });

        addFileBtn.addEventListener('click', () => {
            console.log('Acci√≥n realizada: Bot√≥n + presionado para agregar archivo');
            fileInput.click();
        });

	 

let filename_url={};

fileInput.addEventListener('change', (e) => {
  const files = e.target.files;
  if (!files || files.length === 0) return;

  for (const file of files) {
    const fileIdentifier = `${file.name}-${file.size}-${file.lastModified}`;
     
    // ‚ö†Ô∏è Evitar duplicados antes de crear el preview
    if (uniqueFiles.includes(fileIdentifier)) {
      console.log(`‚ö†Ô∏è Archivo duplicado, ya subido: ${file.name}`);
      continue;
    }

    console.log('Archivo seleccionado:', {
      nombre: file.name,
      tipo: file.type,
      tama√±o: file.size + ' bytes'
    });

    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    fileItem.style.background = 'transparent';

    let fileType = '';
    if (file.type.startsWith('image/')) {
      const img = document.createElement('img');
      img.className = 'file-preview';
      img.src = URL.createObjectURL(file);
      fileItem.appendChild(img);
      fileType = 'image';
      console.log('Imagen agregada a la galer√≠a');
    } else if (file.type.startsWith('video/')) {
      const video = document.createElement('video');
      video.className = 'file-preview';
      video.src = URL.createObjectURL(file);
      video.muted = true;
      fileItem.appendChild(video);
      fileType = 'video';
      filename_url[file.name] = video.src;	
      console.log('Video agregado a la galer√≠a');
    } else if (file.type.startsWith('audio/')) {
      const audio = document.createElement('div');
      audio.textContent = 'üéµ';
      audio.style.fontSize = '40px';
      fileItem.appendChild(audio);
      fileType = 'audio';
      console.log('Audio agregado a la galer√≠a');
	const url_audio = URL.createObjectURL(file);
	filename_url[file.name] = url_audio;
    }

    const fileName = document.createElement('div');
    fileName.className = 'file-name';
    fileName.textContent = file.name;
    fileItem.appendChild(fileName);

    filesGrid.insertBefore(fileItem, addFileBtn);

    // Guarda el tipo de archivo
    if (fileType && file_types[fileType]) {
      file_types[fileType].push(file.name);
    }

    console.log('Archivo agregado:', file.name);
  }

  // üîÅ Ahora s√≠, maneja todos los archivos seleccionados en lote
  handleFileUpload(e);

  console.log('file_types:', file_types);

  // Limpia el input para permitir volver a seleccionar los mismos archivos luego
  fileInput.value = '';
});




 

 
 
 

	 

 
 
         

         

         
 

 
        function hide_stepPreview() {
            let stepPreview = document.getElementById("stepPreview");
            if (stepPreview) {
                stepPreview.style.display = "none";
            }
        }

        function hide_videoTag() {
            let stepVideoTag = document.getElementById("stepVideoTag");
            if (stepVideoTag) {
                stepVideoTag.style.display = "none";
            }
        }

        function show_stepPreview() {
            hide_videoTag(); 
            let stepPreview = document.getElementById("stepPreview");
            if (stepPreview) {
                stepPreview.style.display = "flex";
            }
            resizeCanvas(); 
            start_loading();
        }

        function show_videoTag() {
            hide_stepPreview(); 
            hide_loading_tab();	 
            let stepVideoTag = document.getElementById("stepVideoTag");
            if (stepVideoTag) {
                stepVideoTag.style.display = "flex";
            } 
 
            //document.querySelector('.empty-block').style.display = "flex"; 	
	    create_buttons_properties(current_timeline[0]); 
    	    inicializar();//current_timeline[1]	unica_regla.rectangulos
	    activarBoton(current_timeline[2]);
        }

 

        console.log('Aplicaci√≥n inicializada correctamente');
        console.log('Breakpoints responsive configurados: 500px (75%) y 800px (50%)');
	// Crear tab por defecto al iniciar
	document.addEventListener('DOMContentLoaded', () => {
	    const defaultTabName = 'scene';
	    if (!customNames.includes(defaultTabName)) {
	        //customNames.push(defaultTabName); 
	        console.log('Tab por defecto creado:', defaultTabName);   
	    }
	});

 

   

 


</script>





















































 


<script>
 
let fondoRegla = null;
let lineaRegla = null;


// Datos de entrada
/*
let unica_regla = {
    selectedTab:"",	
    selectedProperty:"",	
    rectangulos: [
        {start: "00:00:00.0", end: "00:00:03.2", start_value: "text1", end_value: "text2","video_audio_value":"empty","bounce":"empty"},
        {start: "00:00:04.0", end: "00:00:06.4", start_value: "text3", end_value: "text4","video_audio_value":"empty","bounce":"empty"}
    ]
};
*/


let unica_regla_00 = {
    selectedTab:"",	
    selectedProperty:"",	
    rectangulos: [{"start":"00:00:00.0","end":"00:00:00.4","start_value":"640,360","end_value":"640,360","video_audio_value":""}]
};

let unica_regla_0 = { 
     scroll_x_filename:0,
     scroll_x_current_group:0,
     scroll_x_position:0,
     scroll_x_scale:0,
     scroll_x_rotation:0,
     scroll_x_opacity:0,
     rectangulos:[

[{"item_name":"","index_item":"0","property":"filename","filetype":"image","start":"00:00:00.0","end":"00:00:00.4","start_value":"img.png","end_value":"","video_audio_value":"",color:"#7c55e6"},{"item_name":"","index_item":"0","property":"filename","filetype":"image","start":"00:00:00.8","end":"00:00:01.4","start_value":"img.png","end_value":"","video_audio_value":"",color:"#7c55e6"}],  
 
[{"item_name":"","index_item":"0","property":"position","filetype":"image","start":"00:00:00.0","end":"00:00:01.0","start_value":"640,360","end_value":"640,360","video_audio_value":"",color:"#7c55e6"},{"item_name":"","index_item":"0","property":"position","filetype":"image","start":"00:00:01.8","end":"00:00:02.4","start_value":"640,360","end_value":"640,360","video_audio_value":"",color:"#7c55e6"}],

[{"item_name":"","index_item":"0","property":"rotation","filetype":"image","start":"00:00:00.0","end":"00:00:01.0","start_value":"640,360","end_value":"640,360","video_audio_value":"",color:"#7c55e6"} ],
 



[{"item_name":"","index_item":"1","property": "filename","filetype":"image","start":"00:00:00.0","end":"00:00:00.4","start_value":"video.mp4","end_value":"","video_audio_value":"",color:"#7c55e6"}],
 
[{"item_name":"","index_item":"1","property": "position","filetype":"image","start":"00:00:00.0","end":"00:00:01.0","start_value":"640,360","end_value":"640,360","video_audio_value":"",color:"#7c55e6"}],
[{"item_name":"","index_item":"1","property": "rotation","filetype":"image","start":"00:00:00.0","end":"00:00:01.0","start_value":"640,360","end_value":"640,360","video_audio_value":"",color:"#7c55e6"}]
 		]
};

let rectangulos_0 = [[],[]];

let unica_regla = { 
     scroll_x:{"filename":0,"group":0,"position":0,"scale":0,"rotation":0,"opacity":0},
     rectangulos:[]
}; 
let rectangulos = [];

let current_view="filename";


let resolution_scene = "1280x720";
const MINUTOS_TOTALES = 30;
const PASO_DELTA = 5;//0.2 segundos
const SEGMENTO_BASE = 20;
const CALIBRACION = 2;
const SEGMENTO = SEGMENTO_BASE * CALIBRACION;
const TOTAL_PUNTOS = MINUTOS_TOTALES*PASO_DELTA*60;
const ALTURA_REGLA = 60;
const PADDING = 40; 
const VALOR_SEGMENTO = 0.2;
let ANCHO_VENTANA_VIRTUAL = window.innerWidth;

let contenedor = document.getElementById('contenedor');
let scrollWrapper = document.querySelector('.scroll-wrapper');
let offsetVirtual = 0;
let marcadoresEnDOM = new Map();
let labelsEnDOM = new Map();
let todosLosMarcadores = [];
let todosLosLabels = [];
 

let arrastreActivo = false;
let rectanguloArrastrado = null;
let offsetInicialX = 0;
let posicionInicialRect = 0;

let redimensionActiva = false;
let rectanguloRedimensionado = null;
let ladoRedimension = '';
let posicionInicialMouse = 0;
let anchoInicial = 0;
let posicionInicialRectRedim = 0;
let rectanguloSeleccionado = null;

// 0.005s = 5ms 
 

/*  
const principal_video = document.getElementById('my-video-2');
const pxPorIntervalo = 2;
const intervalo = 0.01;

let animationId;

let videoControlaScroll = false;   // El video mueve el scroll
let usuarioControlaScroll = false; // El usuario mueve el scroll
let scrollTimeout;

// --- VIDEO -> SCROLL ---
function actualizarScroll() {
    if (usuarioControlaScroll) return; // <- no tocar scroll si el usuario est√° actuando

    const pasos = Math.floor(principal_video.currentTime / intervalo);
    videoControlaScroll = true;
    scrollWrapper.scrollLeft = pasos * pxPorIntervalo;
}

 
function animarScroll() {
    if (usuarioControlaScroll) return;

    const pasos = Math.floor(principal_video.currentTime / intervalo);
    videoControlaScroll = true;
    scrollWrapper.scrollLeft = pasos * pxPorIntervalo;

    animationId = requestAnimationFrame(animarScroll);
}
 

// --- SCROLL -> VIDEO ---
function actualizarVideoPorScroll() {
    const pasos = Math.floor(scrollWrapper.scrollLeft / pxPorIntervalo);
    const nuevoTiempo = pasos * intervalo;

    if (nuevoTiempo <= principal_video.duration) {
        principal_video.currentTime = nuevoTiempo;
    }
  
}

// --- EVENTOS ---

// Usuario mueve el scroll
scrollWrapper.addEventListener('scroll', () => {

    // Si el scroll fue causado por el video ‚Üí ignorar
    if (videoControlaScroll) {
        videoControlaScroll = false; // limpiar la bandera
        return;
    }

    // Desde aqu√≠ s√≠ es scroll del usuario
    usuarioControlaScroll = true;

    // Pausar solo si el usuario interviene
    if (!principal_video.paused) {
        principal_video.pause();
    }

    actualizarVideoPorScroll();

    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
        usuarioControlaScroll = false;
    }, 120);
});


// Play del video ‚Üí el video controla el scroll
principal_video.addEventListener("play", () => {
    usuarioControlaScroll = false;
    cancelAnimationFrame(animationId);
    animationId = requestAnimationFrame(animarScroll);
});

principal_video.addEventListener("pause", () => {
    cancelAnimationFrame(animationId);
    videoControlaScroll = false;
});

principal_video.addEventListener("ended", () => {
    cancelAnimationFrame(animationId);
    videoControlaScroll = false;
});

// seeking / seeked solo sincroniza si NO es el usuario
principal_video.addEventListener("seeking", actualizarScroll);
principal_video.addEventListener("seeked", actualizarScroll);
*/ 

/*
const desplazamiento_pausa = 30;
// --- DETECTOR DE TOUCH/TRACKPAD EN CONTENEDOR --- 
let touchStartX = 0;
let touchStartY = 0;
let mouseStartX = 0;

// Para touch (m√≥vil/tablet)
contenedor.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
}, { passive: true });

contenedor.addEventListener('touchmove', (e) => {
    const touchCurrentX = e.touches[0].clientX;
    const touchCurrentY = e.touches[0].clientY;
    const deltaX = Math.abs(touchCurrentX - touchStartX);
    const deltaY = Math.abs(touchCurrentY - touchStartY);
     
    if (deltaX > desplazamiento_pausa && deltaX > deltaY && !principal_video.paused) {
        usuarioControlaScroll = true; 
        principal_video.pause();
    }
}, { passive: true });

// Para trackpad/mouse (escritorio)
contenedor.addEventListener('mousedown', (e) => {
    mouseStartX = e.clientX;
});

contenedor.addEventListener('mousemove', (e) => {
    // Solo si el bot√≥n est√° presionado (drag)
    if (e.buttons === 1) {
        const deltaX = Math.abs(e.clientX - mouseStartX);
        
        if (deltaX > desplazamiento_pausa && !principal_video.paused) {
            usuarioControlaScroll = true; 	
            principal_video.pause();
        }
    }
});

// Para wheel (rueda del mouse/trackpad)
contenedor.addEventListener('wheel', (e) => {
    // Detectar scroll horizontal
    if (Math.abs(e.deltaX) > desplazamiento_pausa && !principal_video.paused) {
        usuarioControlaScroll = true; 
        principal_video.pause();
    }
}, { passive: true });
*/ 
 










function formatearTiempoDecimal(totalSegundos) {
    /*const totalSeg = Number(totalSegundos);*/
    const totalSeg = Number(totalSegundos.toFixed(2));//toFixed(1)


    // Redondeo a d√©cimas
    let redondeado = Math.round(totalSeg * 10) / 10;

    // Evita valores como 60.0 segundos
    redondeado = Number(redondeado.toFixed(1));

    const horas = Math.floor(redondeado / 3600);
    const minutos = Math.floor((redondeado % 3600) / 60);
    const segundos = Math.floor(redondeado % 60);

    const decima = Math.round((redondeado * 10) % 10);

    let resultado =
        [horas.toString().padStart(2, '0'),
         minutos.toString().padStart(2, '0'),
         segundos.toString().padStart(2, '0')].join(':');

    if (decima > 0) resultado += '.' + decima;

    return resultado;
}
 

function sumarTiempo(timestamp, segundosFlotante, velocidad = 1) {
    // Parsear HH:MM:SS(.d)?
    const [h, m, s] = timestamp.split(':');

    // Normalizar segundos del timestamp a 1 decimal
    const segundosBase = Math.round(parseFloat(s) * 10) / 10;

    // Convertir timestamp completo a segundos
    let total = h * 3600 + m * 60 + segundosBase;

    // Aplicar velocidad ‚Üí duraci√≥n efectiva
    let duracionAjustada = segundosFlotante / velocidad;

    // Redondear duraci√≥n a 1 decimal
    duracionAjustada = Math.round(duracionAjustada * 10) / 10;

    // Sumar duraci√≥n ajustada
    total += duracionAjustada;

    // Redondeo general a 1 decimal para evitar basura
    total = Math.round(total * 10) / 10;

    // Descomponer
    const horas = Math.floor(total / 3600);
    const minutos = Math.floor((total % 3600) / 60);
    let segundos = total - horas * 3600 - minutos * 60;

    // Redondeo final
    segundos = Math.round(segundos * 10) / 10;

    // Caso borde: segundos = 60.0
    if (segundos >= 60) {
        segundos = 0;
        minutos++;
    }

    // Partes finales
    const segundosEnteros = Math.floor(segundos);
    const decima = Math.round((segundos - segundosEnteros) * 10);

    let result =
        String(horas).padStart(2, '0') + ':' +
        String(minutos).padStart(2, '0') + ':' +
        String(segundosEnteros).padStart(2, '0');

    if (decima > 0) result += '.' + decima;

    return result;
}




function timeToSeconds(timeStr) {
    const parts = timeStr.split(':');
    const horas = parseInt(parts[0]);
    const minutos = parseInt(parts[1]);
    const segundosPartes = parts[2].split('.');
    const segundos = parseInt(segundosPartes[0]);
    const decima = segundosPartes[1] ? parseInt(segundosPartes[1]) / 10 : 0;
    return horas * 3600 + minutos * 60 + segundos + decima;
}

 


 



function crearDropdown() {
  const contenedor = document.getElementById("dropdown_property");
  contenedor.style.display = "flex";

  // Borra cualquier contenido previo
  contenedor.innerHTML = "";

  // Crear el dropdown
  const select = document.createElement("select");
  select.id = "mi_dropdown";

  select.innerHTML = `
    <option value="op1">Opci√≥n 1</option>
    <option value="op2">Opci√≥n 2</option>
  `;

  contenedor.appendChild(select);
}


 
 



 




 
function moverOverlay(dx, dy) { 
  const overlay_flecha = document.getElementById('overlay_flecha');
  overlay_regla.style.top = '0'; 
}
function resetOverlay() {
  const overlay_flecha = document.getElementById('overlay_flecha'); 
  overlay_regla.style.top = '0px'; 
}





function seleccionarRectangulo(rect) { 
 
    if (selected_rect){
    	apply_rounded_corners(selected_rect); 
	hide_rect_extrems(selected_rect);
	if (selected_rect){
	selected_rect.style.background = selected_rect.dataset.color;
	}
    }

    selected_rect = rect; 
    if (selected_rect){
    	remove_rounded_corners(selected_rect);
    }
    show_rect_extrems(rect);

    // Deseleccionar el anterior  
    if (rectanguloSeleccionado && rectanguloSeleccionado !== rect) { 
        //rectanguloSeleccionado.style.background = '#7c55e6';//rgb(0,166,104)  
	rectanguloSeleccionado.style.background = rectanguloSeleccionado.dataset.color;
/*
	rectanguloSeleccionado.style.boxShadow = `
    		0 4px 12px rgba(124, 85, 230, 0.4),
        	inset 0 1px 0 rgba(255, 255, 255, 0.4),
        	inset 0 -2px 0 rgba(0, 0, 0, 0.15)
	`; 
*/
    } 
    if (rectanguloSeleccionado && rectanguloSeleccionado == rect){
	rectanguloSeleccionado.style.background = rect.dataset.color; 
    }
 
     
     
 
    
    // Seleccionar el nuevo
    rectanguloSeleccionado = rect;
      
	if (rectanguloSeleccionado.dataset.start_value.includes("/%(bounce)%/")){
		rect.style.background = 'rgb(255, 249, 105)';//rgb(65,134,191)
		box_options=["Delete_box","bounce_parameters"];
	}else{
        	//rect.style.background = '#02f57c';//#02f57c verde claro
		rect.style.background = "#5bd966";	
		const colorActual = window.getComputedStyle(rect).backgroundColor;
		//rect.style.background = colorActual;
		//rect.style.filter = 'grayscale(0.8) brightness(0.7)';
		//rect.style.filter = 'grayscale(0.8) brightness(1.5)'; 

		box_options = ["Delete_file","Add_file","Split","Add_keyframes"];
		if (rect.dataset.property!="filename"){
			console.log("rect.dataset.property MAL:",rect.dataset.property);
			box_options = ["Delete_box","Add_box","keyframe_1","keyframe_2","bounce"];
		}else{
		     if (rect.dataset.filetype=="text"){
			box_options = ["Delete_file","Add_box","Text_input","Split","Add_keyframes"];
		     } 	
		     if (rect.dataset.filetype=="audio"){
			box_options = ["Delete_file","Add_file","Split"];
		     } 		
		}
	} 	
      
 
     

/*
    const emptyBlockContainer = document.querySelector('.empty-block-container');
    if (window.innerWidth > 1000) { 
    	emptyBlockContainer.style.height = `calc(49vh - ${90}px)`;  
    }else{
        emptyBlockContainer.style.height = `calc(100vh - ${90}px)`;
    }
*/
 

const emptyBlockContainer = document.querySelector('.empty-block-container');
const generalMain = document.querySelector('.general-main');

if (window.innerWidth > 1000) { 
    emptyBlockContainer.style.height = `calc(49vh - ${65}px)`;  
} else {
    if (generalMain) {
        const alturaGeneralMain = generalMain.offsetHeight;
        emptyBlockContainer.style.height = `calc(100vh - ${65}px - ${alturaGeneralMain}px)`; 
    }
}

    document.getElementById('segment_options').style.display = "flex"; 
    document.getElementById('botones-alineados').style.display = "flex";
 
    generarBotones(box_options);
 
   
    crearBotonMas(); 

    console.log("SELECCIONADO"); 
 
}




 
 








function deseleccionarRectangulo() {
    if (selected_rect){
    	apply_rounded_corners(selected_rect); 
    }
 
    if (rectanguloSeleccionado) {   
	rectanguloSeleccionado.style.background = '#7c55e6';//rgb(0,166,104) 
	console.log("rectanguloSeleccionado.dataset.color: ",rectanguloSeleccionado.dataset.color); 
/*
	rectanguloSeleccionado.style.boxShadow = `
    		0 4px 12px rgba(124, 85, 230, 0.4),
        	inset 0 1px 0 rgba(255, 255, 255, 0.4),
        	inset 0 -2px 0 rgba(0, 0, 0, 0.15)
	`;  
*/
	rectanguloSeleccionado.style.background = rectanguloSeleccionado.dataset.color;
        rectanguloSeleccionado = null;
    } 
 
  
    // Eliminar el bot√≥n "+"
    const botonAnterior = document.querySelector('.boton-mas');
    if (botonAnterior) botonAnterior.remove();
 
    document.getElementById('botones-alineados').style.display = "none"; 
    document.getElementById('segment_options').style.display = "none";

/*
    const emptyBlockContainer = document.querySelector('.empty-block-container');  
    if (window.innerWidth > 1000){
    	emptyBlockContainer.style.height = `calc(49vh)`;  
    }else{
        emptyBlockContainer.style.height = `calc(100vh)`;
    } 
*/
const emptyBlockContainer = document.querySelector('.empty-block-container');
const generalMain = document.querySelector('.general-main');

if (window.innerWidth > 1000) { 
    emptyBlockContainer.style.height = `calc(49vh)`;  
} else {
    if (generalMain) {
        const alturaGeneralMain = generalMain.offsetHeight;
        emptyBlockContainer.style.height = `calc(100vh - ${alturaGeneralMain}px)`; 
    }
}
	
}
 
 

function show_rect_extrems(rect) {
    if (!rect) { 
        return;
    } 

    const current_filetype = selected_rect.dataset.filetype;
    const current_property_id = selected_rect.dataset.property;

    if (current_filetype=="video" || current_filetype=="audio"){ 
        if (current_property_id=="filename"){
 	    return; 
        }
    }
    // Primero ocultar todos los extremos y resetear z-index de todos
console.log("rectangulos:",rectangulos,rect.dataset.index_row);
    rectangulos[rect.dataset.index_row].forEach(r => {
        r.elemento.style.zIndex = '1'; // z-index base
        const extremos = r.elemento.querySelectorAll('.extremo-blanco');
        extremos.forEach(extremo => {
            extremo.style.display = 'none';
        });
    });
    
    // Elevar el rect√°ngulo seleccionado
    rect.style.zIndex = '10'; // z-index alto para el seleccionado
    
    // Mostrar solo los extremos del rect√°ngulo seleccionado
    const extremos = rect.querySelectorAll('.extremo-blanco');
    if (extremos){
    	extremos.forEach(extremo => {
        	extremo.style.display = 'block';
        	extremo.style.zIndex = '2';
    	}); 
    } 
}

function hide_rect_extrems(rect) { 
    if (!rect) { 
	console.log("rect NOT FOUND");
        return;
    }
    console.log("rect FOUND");
    const extremos = rect.querySelectorAll('.extremo-blanco');
    if (extremos){
    	extremos.forEach(extremo => {
		extremo.style.zIndex = '0';
        	extremo.style.display = 'none';
    	}); 
    } 
}

function apply_rounded_corners(rect) {
    if (rect){
    	rect.style.borderRadius = '8px';
    }
}

function remove_rounded_corners(rect) {
    const current_filetype = selected_rect.dataset.filetype;
    const current_property_id = selected_rect.dataset.property;

    if (current_filetype=="video" || current_filetype=="audio"){ 
        if (current_property_id=="filename"){
 	    return; 
        }
    }
    if (rect){
    	rect.style.borderRadius = '0';
    }
}

function ocultarBotonMas() {
    const boton = document.querySelector('.boton-mas');
    if (boton) {
        boton.style.display = 'none';
    }
} 
function mostrarBotonMas() {
    const boton = document.querySelector('.boton-mas');
    if (boton) {
        boton.style.display = 'block';
    }
}

function opacidad_desplazamiento(rect) {
    if (rect){
    apply_rounded_corners(rect);
    hide_rect_extrems(rect);
    ocultarBotonMas();	
    rect.style.opacity = '0.5';
    }
}

function opacidad_reposo(rect) {
    if (rect){
    remove_rounded_corners(rect);
    show_rect_extrems(rect);
    mostrarBotonMas();
    rect.style.opacity = '1';
    }
}



const LONG_PRESS_TIME = 600;  
let touchTimer = null;
let touchStarted = 0;


function crearRectangulo(datos, indice_rect, index_row, index_global_row) {
    console.log("index_row: ",index_row);
    const yRegla = index_row*ALTURA_REGLA + ALTURA_REGLA/2 ;

    let segundosInicio = timeToSeconds(datos.start);
    let segundosFin = timeToSeconds(datos.end);
    //segundosInicio  = Math.round(segundosInicio  * 10) / 10;
    //segundosFin  = Math.round(segundosFin  * 10) / 10;
    const posicion = PADDING + (segundosInicio / VALOR_SEGMENTO) * SEGMENTO;
    const ancho = ((segundosFin - segundosInicio) / VALOR_SEGMENTO) * SEGMENTO;

    const rect = document.createElement('div');
    rect.classList.add('rectangulo-caja'); 
    rect.style.left = `${posicion - offsetVirtual}px`;
    rect.style.top = `${yRegla}px`;
    rect.style.width = `${ancho}px`; 
    rect.style.backgroundColor = datos.color; 

    rect.style.display = "flex";
    rect.style.flexDirection = "column";  
    rect.style.justifyContent = "flex-end"; 
    rect.style.boxSizing = "border-box"; 
    rect.style.position = "absolute";
 
 

/*
const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24">
    <rect x="3" y="4" width="18" height="16"
      fill="none" stroke="white" stroke-width="2"/>
    <circle cx="9" cy="9" r="2.2" fill="white"/>
    <path d="M4 17l4-4 3 3 4-5 5 6"
      fill="none" stroke="white" stroke-width="2"/>
  </svg>
`;

const svgData = `data:image/svg+xml,${encodeURIComponent(svg)}`; 
rect.style.backgroundImage  = `url("${svgData}")`;
rect.style.backgroundRepeat = "repeat-x";

// 90px ciclo ‚Üí 80px svg + 10px espacio
rect.style.backgroundSize = "80px auto";

// deja 10px en cada extremo sin usar padding
rect.style.backgroundPositionX = "10px";
rect.style.backgroundPositionY = "2px";
rect.style.backgroundSize = "90px 40px";
*/


let nombre_visible_rect = "";
if (current_view=="filename"){
	nombre_visible_rect = datos.item_name + " - " + datos.start_value;
}else{
	nombre_visible_rect = datos.item_name + " - " + datos.property;
}



 
// --- Texto inferior ---
const labelBottom = document.createElement('span'); 

labelBottom.textContent = nombre_visible_rect;//current_view+" ("+"video.mp4"+")" 
labelBottom.style.color = "rgb(255,255,255)";//rgb(20,20,20)
labelBottom.style.fontSize = "14px";
labelBottom.style.fontWeight = "normal";
labelBottom.style.marginBottom = "4px";
labelBottom.style.marginLeft = "16px";
labelBottom.style.whiteSpace = "nowrap";
labelBottom.style.overflow = "hidden";
labelBottom.style.textOverflow = "ellipsis";
labelBottom.style.pointerEvents = "none";
labelBottom.style.userSelect = "none"; 

rect.appendChild(labelBottom);
 

/*
const labelBottom = document.createElement('span');

labelBottom.textContent = current_view + " (" + "video.mp4" + ")";
 
labelBottom.style.color = "rgb(20,20,20)";
labelBottom.style.fontSize = "15px";
labelBottom.style.fontWeight = "normal";
 
labelBottom.style.marginBottom = "4px";
labelBottom.style.marginLeft = "16px";
 
labelBottom.style.display = "inline-block";
labelBottom.style.alignSelf = "flex-start";
 
labelBottom.style.flexShrink = "1";
labelBottom.style.minWidth = "0";
 
labelBottom.style.maxWidth = "calc(100% - 16px - 16px)"; // 16px izquierda + 16px derecha
 
labelBottom.style.whiteSpace = "nowrap";
labelBottom.style.overflow = "hidden";
labelBottom.style.textOverflow = "ellipsis";
 
labelBottom.style.pointerEvents = "none";
labelBottom.style.userSelect = "none";
 
labelBottom.style.backgroundColor = "rgba(255,255,255,0.9)";
labelBottom.style.borderRadius = "6px";
labelBottom.style.padding = "2px 4px";
labelBottom.style.boxSizing = "border-box";

rect.appendChild(labelBottom);
*/

 
 


 
    rect.style.borderLeft = '1px solid rgb(35, 45, 50)';
    rect.style.borderRight = '1px solid rgb(35, 45, 50)';
  
     
    rect.dataset.item_name = datos.item_name; 
    rect.dataset.indice = indice_rect; 
    rect.dataset.property = datos.property;  
    rect.dataset.filetype = datos.filetype; 
    rect.dataset.index_item = datos.index_item;
    rect.dataset.index_global_row = index_global_row;
    rect.dataset.index_row = index_row;
    rect.dataset.xReal = posicion;
    rect.dataset.yReal = ALTURA_REGLA * index_row;
    rect.dataset.widthReal = ancho; 
    rect.dataset.start_value = datos.start_value;  
    rect.dataset.end_value = datos.end_value;
    rect.dataset.video_audio_value = datos.video_audio_value;
    rect.dataset.color = datos.color;
    //datos.row1

    const extremoIzq = document.createElement('div');
    extremoIzq.classList.add('extremo-blanco', 'izquierdo');
    extremoIzq.style.display = 'none';
    rect.appendChild(extremoIzq);

    const extremoDer = document.createElement('div');
    extremoDer.classList.add('extremo-blanco', 'derecho');
    extremoDer.style.display = 'none';
    rect.appendChild(extremoDer);

    contenedor.appendChild(rect);
    console.log("posicion FLOAT:",posicion);
    //aqui se crea la lista
    rectangulos[index_row].push({
        elemento: rect,
        posicion: posicion,
	posicion_y: ALTURA_REGLA * index_row,
        ancho: ancho,
	item_name: datos.item_name,
        index_item: datos.index_item,
        property: datos.property,
        filetype: datos.filetype,
        index_global_row : index_global_row,
        index_row : index_row,
        color: datos.color,
        start_value: datos.start_value,
        end_value: datos.end_value,
	video_audio_value: datos.video_audio_value
    });
    //rectangulos sera una sublist de rectangulos_current_view
    //rectangulos_current_view NO tiene la misma estructura que unica_regla.rectangulos
    console.log("RECT CREADO", rectangulos.length, rectangulos[index_row].length);

 
 

rect.addEventListener('mousedown', (e) => { 
    e.preventDefault();

    if (e.button !== 0) return;

    if (!e.target.classList.contains('extremo-blanco')) { 
        	seleccionarRectangulo(rect); 
		show_rect_extrems(rect); 
    	} 
    let arrastrando = false;

    function onMouseMove(ev) {
        if (!arrastrando) {
            arrastrando = true;
            console.log("Inicio arrastre"); 

            iniciarArrastre(e, rect);  // ‚Üê rect se pasa correctamente
        }

         
    }

    function onMouseUp() {
        arrastrando = false;
        finalizarArrastre(); 
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);
    }

    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
});



// Adem√°s, para m√≥viles, hacemos lo mismo que el mousedown pero con touchstart
rect.addEventListener('touchstart', (e) => {
    if (e.cancelable) {
        e.preventDefault();
    }

    if (!e.target.classList.contains('extremo-blanco')) {
        seleccionarRectangulo(rect); 
	show_rect_extrems(rect);
    } 

    let arrastrando = false;

    function onMove(ev) {
        const evento = ev.touches ? ev.touches[0] : ev;

        if (!arrastrando) {
            arrastrando = true;
            console.log("Inicio arrastre Touch"); 
            iniciarArrastreTouch(e, rect);   
        }
 
    }

    function onUp() {
        arrastrando = false;
        finalizarArrastreTouch(); 
        //window.removeEventListener('mousemove', onMove);
        //window.removeEventListener('mouseup', onUp);
        window.removeEventListener('touchmove', onMove);
        window.removeEventListener('touchend', onUp);
    }

    //window.addEventListener('mousemove', onMove);
    //window.addEventListener('mouseup', onUp);
    window.addEventListener('touchmove', onMove, { passive: false });
    window.addEventListener('touchend', onUp);
}, { passive: false });
 



 
rect.addEventListener('click', (e) => {
    if (e.button !== 0) return;
    if (!arrastreActivo && !redimensionActiva) {
        seleccionarRectangulo(rect); 
    }
});
 	 
 
if (current_filetype=="video" || current_filetype=="audio"){
console.log("MAL REDIM: ",current_property_id);
    if (current_property_id=="filename"){
 	return; 
    }
}
 
    extremoIzq.addEventListener('mousedown', (e) => iniciarRedimension(e, rect, 'izquierdo'));
    extremoDer.addEventListener('mousedown', (e) => iniciarRedimension(e, rect, 'derecho'));

    // M√≥viles
    extremoIzq.addEventListener('touchstart', (e) => iniciarRedimensionTouch(e, rect, 'izquierdo'));
    extremoDer.addEventListener('touchstart', (e) => iniciarRedimensionTouch(e, rect, 'derecho'));
 
 

}

 

function crear_bounce_rectangle() {

    const index_row = selected_rect.dataset.index_row;
    const index_global_row = selected_rect.dataset.index_global_row;

    if (!rectanguloSeleccionado) return; 

    const filaRectangulos = rectangulos[index_row];
    const filaUnica = unica_regla.rectangulos[index_global_row];

    if (!Array.isArray(filaRectangulos) || !Array.isArray(filaUnica)) return;

    const indiceSeleccionado = parseInt(rectanguloSeleccionado.dataset.indice);
    const rectSeleccionado = filaRectangulos[indiceSeleccionado]; 
    if (!rectSeleccionado) return;

    // Validar bounce consecutivos (solo dentro de la fila local)
    if (indiceSeleccionado < filaUnica.length - 1){
        const rectDerechaTest = filaUnica[indiceSeleccionado + 1];
        if (rectDerechaTest.start_value.includes("/%(bounce)%/")){
            showErrorModal("There cannot be two bounce segments stuck together.");
            return;
        }
    } 

    const posicionBoton = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);

    let segundosInicio = (posicionBoton - PADDING) / SEGMENTO * VALOR_SEGMENTO;
    let segundosFin = segundosInicio + VALOR_SEGMENTO; 
    segundosInicio  = Math.round(segundosInicio  * 10) / 10;
    segundosFin  = Math.round(segundosFin  * 10) / 10;
    const nuevoRect = {
	item_name: selected_rect.dataset.item_name,
	index_item: selected_rect.dataset.index_item,
	property: selected_rect.dataset.property,
	filetype: selected_rect.dataset.filetype,
        index_global_row : selected_rect.dataset.index_global_row,
        index_row : selected_rect.dataset.index_row,
        color: "rgb(255, 249, 105)",
        start: formatearTiempoDecimal(segundosInicio),
        end: formatearTiempoDecimal(segundosFin),
        start_value: "3,0.4,/%(bounce)%/",
        end_value: "3,0.4,/%(bounce)%/",
        video_audio_value: ""
    };

 
 
    // Verificar si hay un rect√°ngulo pegado a la derecha
    if (indiceSeleccionado < filaRectangulos.length - 1) {
        const rectDerecha = filaRectangulos[indiceSeleccionado + 1];
        const finSeleccionado = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);
        const inicioDerecha = parseFloat(rectDerecha.posicion);

        if (Math.abs(finSeleccionado - inicioDerecha) < 1) {
            // Desplazar el de la derecha y todos los siguientes un SEGMENTO
            for (let i = indiceSeleccionado + 1; i < filaRectangulos.length; i++) {
                filaRectangulos[i].posicion = parseFloat(filaRectangulos[i].posicion) + SEGMENTO;
                filaRectangulos[i].elemento.dataset.xReal = filaRectangulos[i].posicion;
            }

            // Actualizar el estado global con las nuevas posiciones
            filaUnica.splice(0, filaUnica.length, ...filaRectangulos.map(rect => {
                let segundosInicio = (parseFloat(rect.posicion) - PADDING) / SEGMENTO * VALOR_SEGMENTO; 
                let segundosFin = segundosInicio + (parseFloat(rect.ancho) / SEGMENTO * VALOR_SEGMENTO);
		segundosInicio  = Math.round(segundosInicio  * 10) / 10;
		segundosFin  = Math.round(segundosFin  * 10) / 10;
                console.log("MAL segundosFin: ", segundosFin);
                return {
		    item_name: rect.item_name,
 		    index_item:	rect.index_item,
 		    property: rect.property,
 		    filetype: rect.filetype,
		    index_global_row : selected_rect.dataset.index_global_row,
        	    index_row : selected_rect.dataset.index_row,
		    color: "rgb(255, 249, 105)",
                    start: formatearTiempoDecimal(segundosInicio),
                    end: formatearTiempoDecimal(segundosFin),
                    start_value: rect.start_value,
                    end_value: rect.end_value,
                    video_audio_value: rect.video_audio_value
                };
            }));
        }
    }

    // Insertar el nuevo rect√°ngulo despu√©s del seleccionado
    filaUnica.splice(indiceSeleccionado + 1, 0, nuevoRect);

    // Recrear todos los rect√°ngulos de la fila
    filaRectangulos.forEach(r => r.elemento.remove());
    filaRectangulos.length = 0;

      
    filaUnica.forEach((rectData, index) => { 
        crearRectangulo(rectData, index, index_row,index_global_row);
        console.log("new rectangle");
        actualizarEstadoGlobal();
    });

    // Seleccionar el nuevo
    const nuevoElemento = filaRectangulos[indiceSeleccionado + 1].elemento;
    seleccionarRectangulo(nuevoElemento); 

    renderizarElementosVisibles();
}


function crear_bounce_rectangle_00() {

    const index_row = selected_rect.dataset.index_row;
    const index_global_row = selected_rect.dataset.index_global_row;

    // listas locales (fila concreta)
    let filaLocal = rectangulos[index_row];
    let filaGlobal = unica_regla.rectangulos[index_global_row];

    const botonAnterior = document.querySelector('.boton-mas');
    if (botonAnterior) botonAnterior.remove();

    if (!rectanguloSeleccionado) return;

    const indiceSeleccionado = parseInt(rectanguloSeleccionado.dataset.indice);
    const rectSeleccionado = filaLocal[indiceSeleccionado];

    // Validar bounce consecutivos (solo dentro de la fila local)
    if (indiceSeleccionado < filaLocal.length - 1){
        const rectDerechaTest = filaLocal[indiceSeleccionado + 1];
        if (rectDerechaTest.start_value.includes("/%(bounce)%/")){
            showErrorModal("There cannot be two bounce segments stuck together.");
            return;
        }
    }

    const posicionBoton = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);
    const offsetY = ALTURA_REGLA * 0.5;
    const yRegla = offsetY + ALTURA_REGLA / 2;

    const segundosInicio = (posicionBoton - PADDING) / SEGMENTO * VALOR_SEGMENTO;
    const segundosFin = segundosInicio + VALOR_SEGMENTO;

    const nuevoRect = {
	index_item: selected_rect.dataset.index_item,
	property: selected_rect.dataset.property,
	filetype: selected_rect.dataset.filetype,
        index_global_row : selected_rect.dataset.index_global_row,
        index_row : selected_rect.dataset.index_row,
        start: formatearTiempoDecimal(segundosInicio),
        end: formatearTiempoDecimal(segundosFin),
        start_value: "3,0.4,/%(bounce)%/",
        end_value: "3,0.4,/%(bounce)%/",
        video_audio_value: ""
    };

    // --- si hay rect√°ngulo a la derecha en ESTA FILA ---
    if (indiceSeleccionado < filaLocal.length - 1) {

        const rectDerecha = filaLocal[indiceSeleccionado + 1];
        const finSel = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);
        const inicioDer = parseFloat(rectDerecha.posicion);

        // pegados
        if (Math.abs(finSel - inicioDer) < 1) {

            // desplazar derecha + siguientes SOLO EN ESTA FILA
            for (let i = indiceSeleccionado + 1; i < filaLocal.length; i++) {
                filaLocal[i].posicion =
                    parseFloat(filaLocal[i].posicion) + SEGMENTO;

                filaLocal[i].elemento.dataset.xReal = filaLocal[i].posicion;
            }

            // actualizar fila global correspondiente
            filaGlobal = filaLocal.map(rect => {
                const sIni =
                    (parseFloat(rect.posicion) - PADDING) / SEGMENTO * VALOR_SEGMENTO;
                const sFin =
                    sIni + (parseFloat(rect.ancho) / SEGMENTO * VALOR_SEGMENTO);

                return {
		    index_item:	rect.index_item,
 		    property: rect.property,
 		    filetype: rect.filetype,
		    index_global_row : selected_rect.dataset.index_global_row,
        	    index_row : selected_rect.dataset.index_row,
                    start: formatearTiempoDecimal(sIni),
                    end: formatearTiempoDecimal(sFin),
                    start_value: rect.start_value,
                    end_value: rect.end_value,
                    video_audio_value: rect.video_audio_value
                };
            });

            // guardar la fila actualizada
            unica_regla.rectangulos[index_global_row] = filaGlobal;
        }
    }

    // insertar nuevo rect√°ngulo en AMBAS listas de la fila
    filaGlobal.splice(indiceSeleccionado + 1, 0, nuevoRect);

    // sincronizar estructura
    unica_regla.rectangulos[index_global_row] = filaGlobal;

    // --- recrear SOLO la fila local ---
    filaLocal.forEach(r => r.elemento.remove());
    filaLocal = [];

    filaGlobal.forEach((rectData, index) => {
	crearRectangulo(rectData, index, index_row,index_global_row); 
        actualizarEstadoGlobal();
    });

    // seleccionar el nuevo
    const nuevoElemento = rectangulos[index_row][indiceSeleccionado + 1].elemento;
    seleccionarRectangulo(nuevoElemento);

    renderizarElementosVisibles();
}



function crear_bounce_rectangle_0() {

    const index_row = selected_rect.dataset.index_row;
    const index_global_row = selected_rect.dataset.index_global_row;
 
    const botonAnterior = document.querySelector('.boton-mas');
    if (botonAnterior) { 
	botonAnterior.remove();
    } 

    // Solo crear el bot√≥n si hay un rect√°ngulo seleccionado
    if (!rectanguloSeleccionado) return;
 

    const indiceSeleccionado = parseInt(rectanguloSeleccionado.dataset.indice);
    const rectSeleccionado = rectangulos[indiceSeleccionado];

    if (indiceSeleccionado<rectangulos.length-1){
    	const rectSeleccionadoAnterior = rectangulos[indiceSeleccionado+1];
    	if (rectSeleccionadoAnterior.start_value.includes("/%(bounce)%/")){
		//alert("There cannot be two bounce segments stuck together.");
		showErrorModal("There cannot be two bounce segments stuck together.");
		return;
	} 
    }	

 
 
    
    const posicionBoton = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);
    const offsetY = ALTURA_REGLA * 0.5;
    const yRegla = offsetY + ALTURA_REGLA / 2;
 

  
  
    const segundosInicio = (posicionBoton - PADDING) / SEGMENTO * VALOR_SEGMENTO;
    const segundosFin = segundosInicio + VALOR_SEGMENTO;
    const nuevoRect = {
        start: formatearTiempoDecimal(segundosInicio),
        end: formatearTiempoDecimal(segundosFin),
        start_value: "3,0.4,/%(bounce)%/",
        end_value: "3,0.4,/%(bounce)%/",
	video_audio_value: ""
    };
    
    // Verificar si hay un rect√°ngulo pegado a la derecha
    if (indiceSeleccionado < rectangulos.length - 1) {
        const rectDerecha = rectangulos[indiceSeleccionado + 1];
        const finSeleccionado = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);
        const inicioDerecha = parseFloat(rectDerecha.posicion);
        
        // Si est√°n pegados (sin hueco)
        if (Math.abs(finSeleccionado - inicioDerecha) < 1) {
            // Desplazar el de la derecha y todos los siguientes un SEGMENTO
            for (let i = indiceSeleccionado + 1; i < rectangulos.length; i++) {
                rectangulos[i].posicion = parseFloat(rectangulos[i].posicion) + SEGMENTO;
                rectangulos[i].elemento.dataset.xReal = rectangulos[i].posicion;
            }
            
            // Actualizar el estado global con las nuevas posiciones
            unica_regla.rectangulos = rectangulos.map(rect => {
                const segundosInicio = (parseFloat(rect.posicion) - PADDING) / SEGMENTO * VALOR_SEGMENTO;
                const segundosFin = segundosInicio + (parseFloat(rect.ancho) / SEGMENTO * VALOR_SEGMENTO);
		console.log("MAL segundosFin: ",segundosFin);
                return {
                    start: formatearTiempoDecimal(segundosInicio),
                    end: formatearTiempoDecimal(segundosFin),
                    start_value: rect.start_value,
                    end_value: rect.end_value,
		    video_audio_value: rect.video_audio_value
                };
            });
        }
    }
    
    // Insertar despu√©s del seleccionado
    unica_regla.rectangulos.splice(indiceSeleccionado + 1, 0, nuevoRect);
    
    // Recrear todos los rect√°ngulos
    rectangulos.forEach(r => r.elemento.remove());
    rectangulos = [];
    
    unica_regla.rectangulos.forEach((rectData, index) => {
        crearRectangulo(rectData, index,0,0);
	console.log("new rectangle");
	actualizarEstadoGlobal();
    });
    
    // Seleccionar el nuevo
    const nuevoElemento = rectangulos[indiceSeleccionado + 1].elemento;
    seleccionarRectangulo(nuevoElemento); 
    
    renderizarElementosVisibles();
  
 
}


function add_box_0(){
    if (!rectanguloSeleccionado) return; 

    const indiceSeleccionado = parseInt(rectanguloSeleccionado.dataset.indice);
    const rectSeleccionado = rectangulos[indiceSeleccionado]; 
    
    const posicionBoton = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);
 
    const segundosInicio = (posicionBoton - PADDING) / SEGMENTO * VALOR_SEGMENTO;
    const segundosFin = segundosInicio + VALOR_SEGMENTO; 
    const nuevoRect = {
        start: formatearTiempoDecimal(segundosInicio),
        end: formatearTiempoDecimal(segundosFin),
        start_value: "",
        end_value: "",
	video_audio_value: ""
    };
    
    // Verificar si hay un rect√°ngulo pegado a la derecha
    if (indiceSeleccionado < rectangulos.length - 1) {
        const rectDerecha = rectangulos[indiceSeleccionado + 1];
        const finSeleccionado = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);
        const inicioDerecha = parseFloat(rectDerecha.posicion);
        
        // Si est√°n pegados (sin hueco)
        if (Math.abs(finSeleccionado - inicioDerecha) < 1) {
            // Desplazar el de la derecha y todos los siguientes un SEGMENTO
            for (let i = indiceSeleccionado + 1; i < rectangulos.length; i++) {
                rectangulos[i].posicion = parseFloat(rectangulos[i].posicion) + SEGMENTO;
                rectangulos[i].elemento.dataset.xReal = rectangulos[i].posicion;
            }
            
            // Actualizar el estado global con las nuevas posiciones
            unica_regla.rectangulos = rectangulos.map(rect => {
                const segundosInicio = (parseFloat(rect.posicion) - PADDING) / SEGMENTO * VALOR_SEGMENTO; 
                const segundosFin = segundosInicio + (parseFloat(rect.ancho) / SEGMENTO * VALOR_SEGMENTO);
	console.log("MAL segundosFin: ",segundosFin);
                return {
                    start: formatearTiempoDecimal(segundosInicio),
                    end: formatearTiempoDecimal(segundosFin),
                    start_value: rect.start_value,
                    end_value: rect.end_value,
		    video_audio_value: rect.video_audio_value
                };
            });
        }
    }
    
    // Insertar despu√©s del seleccionado
    unica_regla.rectangulos.splice(indiceSeleccionado + 1, 0, nuevoRect);
    
    // Recrear todos los rect√°ngulos
    rectangulos.forEach(r => r.elemento.remove());
    rectangulos = [];
    
    unica_regla.rectangulos.forEach((rectData, index) => {
        crearRectangulo(rectData, index,0,0);
	console.log("new rectangle");
	actualizarEstadoGlobal();
    });
    
    // Seleccionar el nuevo
    const nuevoElemento = rectangulos[indiceSeleccionado + 1].elemento;
    seleccionarRectangulo(nuevoElemento); 
    
    renderizarElementosVisibles();
 
}


function add_box() {

    const index_row = selected_rect.dataset.index_row;
    const index_global_row = selected_rect.dataset.index_global_row;

    if (!rectanguloSeleccionado) return; 

    const filaRectangulos = rectangulos[index_row];
    const filaUnica = unica_regla.rectangulos[index_global_row];

    if (!Array.isArray(filaRectangulos) || !Array.isArray(filaUnica)) return;

    const indiceSeleccionado = parseInt(rectanguloSeleccionado.dataset.indice);
    const rectSeleccionado = filaRectangulos[indiceSeleccionado]; 
    if (!rectSeleccionado) return;

    const posicionBoton = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);

    let segundosInicio = (posicionBoton - PADDING) / SEGMENTO * VALOR_SEGMENTO;
    let segundosFin = segundosInicio + VALOR_SEGMENTO; 
    segundosInicio  = Math.round(segundosInicio  * 10) / 10;
    segundosFin  = Math.round(segundosFin  * 10) / 10;
    const nuevoRect = {
	item_name: selected_rect.dataset.item_name,
	index_item: selected_rect.dataset.index_item,
	property: selected_rect.dataset.property,
	filetype: selected_rect.dataset.filetype,
        index_global_row : selected_rect.dataset.index_global_row,
        index_row : selected_rect.dataset.index_row,
	color: selected_rect.dataset.color,
        start: formatearTiempoDecimal(segundosInicio),
        end: formatearTiempoDecimal(segundosFin),
        start_value: "",
        end_value: "",
        video_audio_value: ""
    };

 
 
    // Verificar si hay un rect√°ngulo pegado a la derecha
    if (indiceSeleccionado < filaRectangulos.length - 1) {
        const rectDerecha = filaRectangulos[indiceSeleccionado + 1];
        const finSeleccionado = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);
        const inicioDerecha = parseFloat(rectDerecha.posicion);

        if (Math.abs(finSeleccionado - inicioDerecha) < 1) {
            // Desplazar el de la derecha y todos los siguientes un SEGMENTO
            for (let i = indiceSeleccionado + 1; i < filaRectangulos.length; i++) {
                filaRectangulos[i].posicion = parseFloat(filaRectangulos[i].posicion) + SEGMENTO;
                filaRectangulos[i].elemento.dataset.xReal = filaRectangulos[i].posicion;
            }

            // Actualizar el estado global con las nuevas posiciones
            filaUnica.splice(0, filaUnica.length, ...filaRectangulos.map(rect => {
                let segundosInicio = (parseFloat(rect.posicion) - PADDING) / SEGMENTO * VALOR_SEGMENTO; 
                let segundosFin = segundosInicio + (parseFloat(rect.ancho) / SEGMENTO * VALOR_SEGMENTO);
		segundosInicio  = Math.round(segundosInicio  * 10) / 10;
		segundosFin  = Math.round(segundosFin  * 10) / 10;
                console.log("MAL segundosFin: ", segundosFin);
                return {
		    item_name: rect.item_name,
 		    index_item:	rect.index_item,
 		    property: rect.property,
 		    filetype: rect.filetype,
		    index_global_row : selected_rect.dataset.index_global_row,
        	    index_row : selected_rect.dataset.index_row,
		    color: rect.color,
                    start: formatearTiempoDecimal(segundosInicio),
                    end: formatearTiempoDecimal(segundosFin),
                    start_value: rect.start_value,
                    end_value: rect.end_value,
                    video_audio_value: rect.video_audio_value
                };
            }));
        }
    }

    // Insertar el nuevo rect√°ngulo despu√©s del seleccionado
    filaUnica.splice(indiceSeleccionado + 1, 0, nuevoRect);

    // Recrear todos los rect√°ngulos de la fila
    filaRectangulos.forEach(r => r.elemento.remove());
    filaRectangulos.length = 0;

      
    filaUnica.forEach((rectData, index) => { 
        crearRectangulo(rectData, index, index_row,index_global_row);
        console.log("new rectangle");
        actualizarEstadoGlobal();
    });

    // Seleccionar el nuevo
    const nuevoElemento = filaRectangulos[indiceSeleccionado + 1].elemento;
    seleccionarRectangulo(nuevoElemento); 

    renderizarElementosVisibles();
}





function crearBotonMas() {
    return;
 
    const overlay_regla = document.getElementById('overlay_regla');
    const botonAnterior = document.querySelector('.boton-mas');
    if (botonAnterior) botonAnterior.remove();

    // Solo crear el bot√≥n si hay un rect√°ngulo seleccionado
    if (!rectanguloSeleccionado) return;  

    const indiceSeleccionado = parseInt(rectanguloSeleccionado.dataset.indice);
    const rectSeleccionado = rectangulos[indiceSeleccionado];  
    
    const posicionBoton = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);
    const offsetY = 0;//ALTURA_REGLA * 0.5
    const yRegla = offsetY + ALTURA_REGLA * 0.5;

    const boton = document.createElement('button');
    boton.classList.add('boton-mas');
    boton.textContent = '+'; 
    boton.style.position = 'absolute';
    boton.style.left = `${10+posicionBoton - offsetVirtual}px`;//6 es la mitad del ancho del extremo
    boton.style.top = `${yRegla*1.40}px`; 
    boton.dataset.xReal = posicionBoton;
    boton.style.zIndex = '50';

console.log("BOTON CREADO 0"); 
boton.addEventListener('click', (e) => {
    e.stopPropagation();
  
    let segundosInicio = (posicionBoton - PADDING) / SEGMENTO * VALOR_SEGMENTO;
    let segundosFin = segundosInicio + VALOR_SEGMENTO;//quitar el *2(genera rectangulo de 0.4,new rectangle) 
    const nuevoRect = {
        start: formatearTiempoDecimal(segundosInicio),
        end: formatearTiempoDecimal(segundosFin),
        start_value: "",
        end_value: "",
	video_audio_value: ""
    };
    
    // Verificar si hay un rect√°ngulo pegado a la derecha
    if (indiceSeleccionado < rectangulos.length - 1) {
	console.log("BOTON CREADO 1"); 
        const rectDerecha = rectangulos[indiceSeleccionado + 1];
        const finSeleccionado = parseFloat(rectSeleccionado.posicion) + parseFloat(rectSeleccionado.ancho);
        const inicioDerecha = parseFloat(rectDerecha.posicion);
        
        // Si est√°n pegados (sin hueco)
        if (Math.abs(finSeleccionado - inicioDerecha) < 1) {
            // Desplazar el de la derecha y todos los siguientes un SEGMENTO
            for (let i = indiceSeleccionado + 1; i < rectangulos.length; i++) {
                rectangulos[i].posicion = parseFloat(rectangulos[i].posicion) + SEGMENTO;
                rectangulos[i].elemento.dataset.xReal = rectangulos[i].posicion;
            }
            
            // Actualizar el estado global con las nuevas posiciones
            unica_regla.rectangulos = rectangulos.map(rect => {
                let segundosInicio = (parseFloat(rect.posicion) - PADDING) / SEGMENTO * VALOR_SEGMENTO; 
                let segundosFin = segundosInicio + (parseFloat(rect.ancho) / SEGMENTO * VALOR_SEGMENTO); 
	console.log("MAL segundosFin: ",segundosFin);
                return {
                    start: formatearTiempoDecimal(segundosInicio),
                    end: formatearTiempoDecimal(segundosFin),
                    start_value: rect.start_value,
                    end_value: rect.end_value,
		    video_audio_value: rect.video_audio_value
                };
            });
        }
    }
    
    // Insertar despu√©s del seleccionado
    unica_regla.rectangulos.splice(indiceSeleccionado + 1, 0, nuevoRect);
    
    // Recrear todos los rect√°ngulos
    rectangulos.forEach(r => r.elemento.remove());
    rectangulos = [];
    
    unica_regla.rectangulos.forEach((rectData, index) => {
        crearRectangulo(rectData, index,0);
	console.log("new rectangle");
	actualizarEstadoGlobal();
    });
    
    // Seleccionar el nuevo
    const nuevoElemento = rectangulos[indiceSeleccionado + 1].elemento;
    seleccionarRectangulo(nuevoElemento); 
    
    renderizarElementosVisibles();
    console.log("BOTON CREADO 2"); 
});
    contenedor.appendChild(boton);
    console.log("BOTON CREADO");
}

 

 

 


function actualizarPosicionesVisuales() {
     
    rectangulos.forEach(row => {
        //console.log("ERROR: ",rectangulos.length, row);
        row.forEach(rect => {
        	rect.elemento.style.left = `${parseFloat(rect.posicion) - offsetVirtual}px`;
        	rect.elemento.style.width = `${rect.ancho}px`;
    	});
    }); 
}

function actualizarEstadoGlobal() {

  const index_row = selected_rect.dataset.index_row;
  const index_global_row = selected_rect.dataset.index_global_row; 
  console.log("indices:",index_row,index_global_row);

  const grupo = rectangulos[index_row];
  if (!Array.isArray(grupo)) return;

  // Nos aseguramos de que exista la estructura destino
  if (!Array.isArray(unica_regla.rectangulos[index_global_row])) {
    unica_regla.rectangulos[index_global_row] = [];
  }

console.log("unica_regla CURRENT:",JSON.stringify(unica_regla) );
  unica_regla.rectangulos[index_global_row] = grupo.map(rect => {

    const posicion = parseFloat(rect.posicion);
    const ancho    = parseFloat(rect.ancho);

    let segundosInicio =
      (posicion - PADDING) / SEGMENTO * VALOR_SEGMENTO;

    let segundosFin =
      segundosInicio + (ancho / SEGMENTO * VALOR_SEGMENTO);

    segundosInicio  = Math.round(segundosInicio  * 10) / 10;
    segundosFin  = Math.round(segundosFin  * 10) / 10;

    console.log(
      "segundosFin:",
      segundosFin,
      formatearTiempoDecimal(segundosFin)
    );

    return {
      item_name: rect.item_name,
      index_item : rect.index_item,
      property : rect.property,
      filetype:	rect.filetype,
      index_row: index_row,
      index_global_row: index_global_row,
      color: rect.color,	
      start : formatearTiempoDecimal(segundosInicio),
      end   : formatearTiempoDecimal(segundosFin), 
      start_value      : rect.start_value,
      end_value        : rect.end_value,
      video_audio_value: rect.video_audio_value
    };
  });
 
    send_rectangles("actualizarEstadoGlobal"); 
 
}


function actualizarEstadoGlobal_0() { 
 
    unica_regla.rectangulos = rectangulos.map(rect => {
        const segundosInicio = (parseFloat(rect.posicion) - PADDING) / SEGMENTO * VALOR_SEGMENTO;
        const segundosFin = segundosInicio + (parseFloat(rect.ancho) / SEGMENTO * VALOR_SEGMENTO);
	console.log("segundosFin: ",segundosFin," ",formatearTiempoDecimal(segundosFin));
        return {
            start: formatearTiempoDecimal(segundosInicio),
            end: formatearTiempoDecimal(segundosFin),
            start_value: rect.start_value,
            end_value: rect.end_value,
	    video_audio_value: rect.video_audio_value
        };
    });

 
 
    let current_params = "empty";//time=true 

    const json_data =  {"service":"save_item_data","itemName":current_item,"property":unica_regla.selectedProperty,"params":current_params, "rectangulos":unica_regla.rectangulos,"extra":"mal"};
 
 
    websocketClient.send(JSON.stringify(json_data)); 
    console.log('Estado actualizado:', JSON.stringify(unica_regla, null, 2));

     
}

function renderizarElementosVisibles() {

    const scrollLeft = scrollWrapper.scrollLeft;
    //PADDING + TOTAL_PUNTOS * SEGMENTO + PADDING (original)
    const anchoReal = PADDING + TOTAL_PUNTOS * SEGMENTO + PADDING;
    offsetVirtual = Math.max(0, scrollLeft);
    if (offsetVirtual + ANCHO_VENTANA_VIRTUAL > anchoReal) {
        offsetVirtual = Math.max(0, anchoReal - ANCHO_VENTANA_VIRTUAL);
    }
    contenedor.style.transform = `translateX(${offsetVirtual}px)`;

    const minX = offsetVirtual;
    const maxX = offsetVirtual + ANCHO_VENTANA_VIRTUAL;
    const marcadoresVisibles = new Set();
    const labelsVisibles = new Set();
 
 

 

const marcadores_fijos = document.getElementById('marcadores_fijos'); 
 
todosLosMarcadores.forEach((data, index) => {
    if (data.x < minX || data.x > maxX) return; // fuera de rango

    // ‚ú® Saltamos m√∫ltiplos de 5
    if (index % 5 === 0) {
        // Si la bolita exist√≠a previamente en el DOM, la eliminamos
        if (marcadoresEnDOM.has(index)) {
            const marcadorExistente = marcadoresEnDOM.get(index);
            marcadorExistente.remove();
            marcadoresEnDOM.delete(index);
        }
        return;
    }

    // Marcadores visibles normales
    marcadoresVisibles.add(index);

    if (!marcadoresEnDOM.has(index)) {
        const diametro = 4; // di√°metro de la bolita

        const marcador = document.createElement('div');
        marcador.classList.add('marcador');

        marcador.style.width = `${diametro}px`;
        marcador.style.height = `${diametro}px`;
        marcador.style.backgroundColor = "rgb(150,150,150)"; // blanco
        marcador.style.borderRadius = "50%";
        marcador.style.position = "absolute";

        // Centrado vertical
        marcador.style.top = `${(ALTURA_REGLA * 0.5 / 3 + 4) - diametro / 2}px`;
        // Centrado horizontal
        marcador.style.left = `${data.x - offsetVirtual - diametro / 2}px`;

        marcadores_fijos.appendChild(marcador);
        marcadoresEnDOM.set(index, marcador);
    } else {
        // Solo movemos la bolita si ya existe
        const marcador = marcadoresEnDOM.get(index);
        const diametro = 3;
        marcador.style.left = `${data.x - offsetVirtual - diametro / 2}px`;
    }
}); 

     
    todosLosLabels.forEach((data, index) => {
        if (data.x >= minX && data.x <= maxX) {
            labelsVisibles.add(index);
            if (!labelsEnDOM.has(index)) {
                const label = document.createElement('div');
                label.classList.add('label-medicion');
                label.textContent = data.texto;
                label.style.top = `${data.top}px`;
                label.style.left = `${data.x - offsetVirtual}px`;
                marcadores_fijos.appendChild(label);
                labelsEnDOM.set(index, label);
            } else {
                labelsEnDOM.get(index).style.left = `${data.x - offsetVirtual}px`;
            }
        }
    });	

 
 
    marcadoresEnDOM.forEach((elemento, index) => {
        if (!marcadoresVisibles.has(index)) {
            elemento.remove();
            marcadoresEnDOM.delete(index);
        }
    });
 
    labelsEnDOM.forEach((elemento, index) => {
        if (!labelsVisibles.has(index)) {
            elemento.remove();
            labelsEnDOM.delete(index);
        }
    }); 

    actualizarPosicionesVisuales();
}

function ajustarScrollWrapper() { 	 
    const anchoReal = PADDING + TOTAL_PUNTOS * SEGMENTO + PADDING;
    const scrollContent = document.createElement('div');
    scrollContent.style.width = `${anchoReal}px`;
    scrollContent.style.height = '1px';
    scrollContent.style.position = 'absolute';
    scrollContent.style.top = '0';
    scrollContent.style.left = '0';
    scrollContent.style.pointerEvents = 'none';
    contenedor.appendChild(scrollContent);
}

function cmToPx(cm) {
  const pasos = Math.round(cm / 0.2); 
  return pasos * 40;
}

function setRulerPosition(cm) {
  const custom_x = cmToPx(cm);  // convertimos cm ‚Üí px
  scrollWrapper.scrollLeft = custom_x; // movemos la cinta
}


const time_inicial = formatearTiempoDecimal(24); 
console.log("time_inicial: ",time_inicial);



function inicializar() {
/* 
    //descomentar
    crearPseudoRegla();
    crearRegla();
    ajustarScrollWrapper();
*/ 
    resetear(); 

    //descomentar 
    //renderizarElementosVisibles(); 

    let initial_scroll_x = current_scroll_x;
    initial_scroll_x = unica_regla.scroll_x[current_view];	
     
    setRulerPosition(initial_scroll_x);
 	
    scrollWrapper.addEventListener('scroll', () => {

        const posicion = scrollWrapper.scrollLeft;  
        const pasos = Math.floor(posicion / 40);  
        const cmExacto = parseFloat((pasos * 0.2).toFixed(1));
        current_scroll_x = cmExacto;
        const time = formatearTiempoDecimal(parseFloat(cmExacto));
  
 
        //console.log("cinta position: ",time, ", ",cmExacto,", ",current_scroll_x);
        setTimeout(renderizarElementosVisibles, 20);

    }, { passive: true });

    	 
         
    document.addEventListener("click", (e) => {
	if (e.target.closest("#modal_overlay_dinamico") ||
      		e.target.closest("#modal_box_dinamico") || e.target.closest("#segment_options")) {
    		return;
  	}
	if (selected_rect){ 
	   const index_row = selected_rect.dataset.index_row; 
	   const indice = selected_rect.dataset.indice; 
           if (rectangulos[index_row][indice]){
	        if (!rectangulos[index_row][indice].elemento.contains(e.target)){  
			resetOverlay();	 
	        	deseleccionarRectangulo();
			hide_rect_extrems(selected_rect);
	        }
	   }
	}
/*
        if (!e.target.closest("#tab-contents")) {
        	console.log("fuera");  	
		resetOverlay();	
		//show_vertical_line();
	        deseleccionarRectangulo();
		hide_rect_extrems(selected_rect);
        } 
*/
    });



}


function finalizar() {
    const contenedor = document.getElementById('contenedor');
    if (contenedor) {
        // Eliminar todo su contenido
        while (contenedor.firstChild) {
            contenedor.removeChild(contenedor.firstChild);
        }
        console.log("Todo el contenido dentro de #contenedor ha sido eliminado.");
    } else {
        console.warn("No se encontr√≥ el elemento con id='contenedor'.");
    }  
}
 
 

function resetear() {
    // 1Ô∏è‚É£ Limpiar contenedor visual
    if (contenedor) {
        while (contenedor.firstChild) {
            contenedor.removeChild(contenedor.firstChild);
        }
    }
    const div = document.getElementById("marcadores_fijos");
	div.innerHTML = ""; // borra todo el contenido dentro del div


    // 2Ô∏è‚É£ Resetear arrays globales
    //OPCION A 	
    //rectangulos = [[],[]];

    //OPCION B
    rectangulos.forEach(sublist => sublist.length = 0); 

    console.log("rectangulos rectangulos rectangulos: ",rectangulos);
    todosLosMarcadores = [];
    todosLosLabels = [];
    marcadoresEnDOM.clear();
    labelsEnDOM.clear();

    // 3Ô∏è‚É£ Volver a crear la regla base y los rect√°ngulos
    crearPseudoRegla();
    crearRegla(); 
    ajustarScrollWrapper();

    // 4Ô∏è‚É£ Cargar nueva data 
    /*
    unica_regla.rectangulos.forEach((rectData, index) => {
        crearRectangulo(rectData, index, 0);  
    });*/
 
    if (current_view != "group"){
    let index_visible = 0; 
    unica_regla.rectangulos.forEach((rect_list, index_regla) => { 
        console.log("index_regla: ",index_regla); 
        if (rect_list[0].property == current_view){ 
		for (let i=0; i < rect_list.length; i++){ 
			console.log("i: ",i, index_visible);
			crearRectangulo(rect_list[i],i, index_visible,index_regla);  
		} 
		index_visible = index_visible + 1;
	} 
    });
    }else{  	
    const current_index_item = selected_rect.dataset.index_item;
    let index_visible = 0; 
    unica_regla.rectangulos.forEach((rect_list, index_regla) => {  
	console.log("MAL4:",rect_list[0].index_item,rect_list[0],"\n\n",index_visible,index_regla);
        if (rect_list[0].index_item == current_index_item && rect_list[0].property!="filename"){  
		rectangulos.push([]);
		crearRectangulo(rect_list[0],0, index_visible,index_regla);   
		index_visible = index_visible + 1;   
	} 
    });
    }
    console.log("lista0:",JSON.stringify(rectangulos)); 
    //eliminarSublistasVacias();
    console.log("lista despues0:",JSON.stringify(rectangulos));

/* 
    console.log("00 unica_regla.rectangulos: ",unica_regla.rectangulos);
    unica_regla.rectangulos.forEach((rectData, index) => {
        //console.log("rectData.dataset.indice:", rectData.dataset.indice);
	crearRectangulo(rectData, 1, ALTURA_REGLA);
    });	
*/ 
 
    // 5Ô∏è‚É£ Re-render
    renderizarElementosVisibles();
}


function reemplazarGuionesEnLista(lista) {
    return lista.map(texto => texto.replace(/_/g, " "));
}
function reemplazarGuionesPorEspacios(texto) {
    return texto.replace(/_/g, " ");
}


/*
function create_buttons_properties(id_buttons) {
	document.getElementById('propiedades_regla').style.display = "flex";
    const container = document.getElementById("propiedades_regla");

    // Limpiar contenido previo
    container.innerHTML = "";

    // Crear los botones a partir del array id_buttons
    id_buttons.forEach(id => {
        const btn = document.createElement("button");
        btn.classList.add("button_property");
        btn.id = id;
	if (id=="item_configuration"){
		btn.textContent = "‚Ä¢‚Ä¢‚Ä¢";
		btn.style.color = "rgb(25, 25, 25)";
		btn.style.backgroundColor = "rgb(196, 205, 208)";
		btn.style.marginRight = "5px";
	}else{
        	btn.textContent = reemplazarGuionesPorEspacios(id); // texto visible del bot√≥n
	}
        container.appendChild(btn);
    });
}
 

 

 

function activarBoton(idBoton) {
    const botones = document.querySelectorAll("#propiedades_regla .button_property");
    const botonActivo = document.getElementById(idBoton);

    if (!botonActivo) return;

    botones.forEach(boton => {
        boton.classList.remove("simulado_activo");
    });

    botonActivo.classList.add("simulado_activo");
}




document.getElementById("propiedades_regla").addEventListener("click", (event) => {
    if (event.target.classList.contains("button_property")) { 
	if (event.target.id === current_property_id) {
            return;
        }
	if (event.target.id == "item_configuration"){
	    console.log("item_configuration");	
	    abrirModalDinamicoSimple(html_item_configuration);	
	    return;	
	}
	current_property_id = event.target.id; 
        console.log("Bot√≥n presionado 2:", event.target.id); 

//actualizar inicio de timeline
let current_params = "time="+current_scroll_x;//time=true 
 
//unica_regla.selectedTab
const json_data_0 =  {"service":"save_item_data","itemName":current_item,"property":unica_regla.selectedProperty,"params":current_params, "rectangulos":unica_regla.rectangulos,"extra":"time"}; 
    //ajustarIntervalosBounce();//mantener comentado
    websocketClient.send(JSON.stringify(json_data_0)); 
 



	const json_data = {"service":"change_item_view","itemName":current_item,"property":event.target.id,"params":"empty","file_type":selectedOption_item,"resolution":resolution_scene,"extra0":"","extra":""}; 
	crear_loading_tab();
	websocketClient.send(JSON.stringify(json_data)); 
	finalizar();
    }
});
*/


function create_buttons_properties(id_buttons) { 
}
function activarBoton(idBoton) { 
}





let lista_propiedades = ["filename","temperature"];
 
 

function crear_loading_tab(){
	deseleccionarRectangulo();
	const empty_block = document.querySelector(".empty-block");
            if (empty_block) {
                empty_block.style.display = "none";
            }

	const item_loader = document.getElementById("item-loader");
            if (item_loader) {
		console.log("exists");
                item_loader.style.display = "flex";
            }
 
}

 
function hide_loading_tab() { 
    const empty_block = document.querySelector(".empty-block");
            if (empty_block) {
                empty_block.style.display = "flex";
            }

	const item_loader = document.getElementById("item-loader");
            if (item_loader) {
		console.log("exists");
                item_loader.style.display = "none";
            }
}

 

 
function obtenerInputsYSelects(htmlString) {//solo funciona si hay 1 solo div principal
    // Crear un contenedor temporal
    const temp = document.createElement("div");
    temp.innerHTML = htmlString.trim();

    // Obtener el div principal
    const rootDiv = temp.firstElementChild;
    if (!rootDiv) return [];

    // Buscar inputs y selects
    const elementos = rootDiv.querySelectorAll("input, select"); 

    const resultado = [];

    elementos.forEach(el => {
        if (el.id) {
            resultado.push([
                el.id,
                el.tagName.toLowerCase(),   // "input" o "select"
                el.value ?? ""              // valor o string vac√≠o
            ]);
        }
    });

    return resultado;
}


function obtenerInputsYSelects_2(html) { 

    // Obtener el div principal
    const rootDiv = html.firstElementChild;
    if (!rootDiv) return [];

    // Buscar inputs y selects
    const elementos = rootDiv.querySelectorAll("input, select");

    const resultado = [];

    elementos.forEach(el => {
        if (el.id) {
            resultado.push([
                el.id,
                el.tagName.toLowerCase(),   // "input" o "select"
                el.value ?? ""              // valor o string vac√≠o
            ]);
        }
    });

    return resultado;
}


function agregarOptions(htmlString, valores) {
    const temp = document.createElement("div");
    temp.innerHTML = htmlString.trim();

    const select = temp.querySelector("select#selector_dinamico");
    if (!select) return htmlString;

    // Agregar las nuevas opciones sin borrar las existentes
    valores.forEach((val, i) => {
        const option = document.createElement("option");
        option.id = `option_${i}`;
        option.value = val;
        option.textContent = val;
        select.appendChild(option);
    });

    return temp.innerHTML;
}

 
function obtenerIndicesBounce() {
  let indices = [];

  for (let i = 0; i < unica_regla.rectangulos.length; i++) {
    if (unica_regla.rectangulos[i].start_value.includes("/%(bounce)%/")) {
      indices.push(i);
    }
  }

  return indices;
}




function ajustarIntervalosBounce() {

if (!selected_rect) return;
const i = parseInt(selected_rect.dataset.indice); 
console.log("INDEX: ",i);

const list = obtenerIndicesBounce();
console.log("list_2: ",list);
if (!list.includes(i)) return;
 
 
if (!unica_regla.rectangulos[i]) return;
if (!rectangulos[i]) return;
	
 
    const startActual = timeToSeconds(unica_regla.rectangulos[i].start);
    const endActual   = timeToSeconds(unica_regla.rectangulos[i].end);
    const duracion    = endActual - startActual; 
    const endAnterior = timeToSeconds(unica_regla.rectangulos[i - 1].end);

    unica_regla.rectangulos[i].start = formatearTiempoDecimal(endAnterior);
    unica_regla.rectangulos[i].end   = formatearTiempoDecimal(endAnterior + duracion);

    //unica_regla.rectangulos[i].start = "00:00:00.8";
    //unica_regla.rectangulos[i].end   = "00:00:01.0";

 
 
 

    rectangulos[i].start = formatearTiempoDecimal(endAnterior);
    rectangulos[i].end   = formatearTiempoDecimal(endAnterior + duracion);

    //rectangulos[i].start = "00:00:00.8";
    //rectangulos[i].end   = "00:00:01.0";

        current_timeline[1]=rectangulos; 
	create_buttons_properties(current_timeline[0]);  
    	inicializar();
	activarBoton(current_property_id);	
 
}


 
















 
 








 


 
 

function generarInputsDinamicos(listaDeTitulos, custom_name) {
    let html = `<strong style="width:100%;margin-bottom:10px;">Keyframe 1</strong>`;

    for (const titulo of listaDeTitulos) {
        html += `
            <div id="inputxd" style="display:flex; flex-wrap:wrap; align-items:center; margin-bottom:10px; gap:8px;">
                <strong style="min-width:70px;">${titulo}</strong>
                <input 
                    id="input_${titulo.replace(/\s+/g, '_')}"
                    type="text"
                    data-source="${custom_name}"
                    style="flex:1; min-width:65px; max-width:65px; padding:4px; border-radius:6px;"
                >
            </div>
        `;
    }

    return html;
}
function setInputValues(listaDePares) {
    for (const [titulo, valor] of listaDePares) {
        const id = "input_" + titulo.replace(/\s+/g, '_');
        const input = document.getElementById(id);
        if (!input) continue;
        input.value = valor;
    }
}









 
 

 
 

function generarSelectDinamico() {
  let options = "";

 
const current_files = file_types[current_filetype]; 
for (let i=0;i < current_files.length;i++) { 
    options += `<option value="${current_files[i]}">${current_files[i]}</option>`;
  } 
/*
//los keys son unicos, los de arriba no.
  for (const key in visible_names) { 
    options += `<option value="${key}">${key}</option>`;
  } 
*/

  return `  
    <select id="selector_dinamico" class="dropdown_selector" style="
      width:100%;
      padding:10px 12px;
      font-size:14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.7);
      background:linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(210,240,255,0.9) 50%, rgba(180,220,255,0.95) 100%);
      box-shadow:0 2px 6px rgba(0,0,0,0.25), inset 0 1px 2px rgba(255,255,255,0.8);
      backdrop-filter:blur(4px);
      appearance:none;
      cursor:pointer;
    ">
      <option disabled selected>Select file</option>
      ${options}
    </select>
  `;
}
 
function setOption(optionKey) { 
    const select = document.getElementById("selector_dinamico");
    if (!select) return;

    // Buscar la opci√≥n por su valor (que es el key)
    const optionToSelect = select.querySelector(`option[value="${optionKey}"]`);
    if (!optionToSelect) return;

    // Cambiar la selecci√≥n
    select.value = optionKey;

    // Disparar manualmente el evento "change" por si tienes listeners
    select.dispatchEvent(new Event("change"));
}

document.addEventListener("change", function(e) {
    if (e.target.matches("#selector_dinamico")) {
	const valor = e.target.value;
	const indice = parseInt(selected_rect.dataset.indice);
	unica_regla.rectangulos[indice].start_value = valor;
            rectangulos[indice].start_value = valor;  

	unica_regla.rectangulos[indice].end_value = valor;
            rectangulos[indice].end_value = valor;
            actualizarEstadoGlobal();
        console.log("Key seleccionado:", e.target.value);
        if (valor in visible_names) {
		console.log("VISIBLE NAMES: ",valor);
  		filenames_llenos=filenames_llenos+1;
	}
	//filenames_llenos=filenames_llenos+1;

	//agregarBotonInterval();
	if (valor!=""){
		const div_interval = document.getElementById("btn_select_interval");
		if (div_interval && current_filetype=="video"){ 
			div_interval.style.display = "block";
		}
		if (div_interval && current_filetype=="audio"){ 
			div_interval.style.display = "block";
		}
	}
    }
});
 









 

function agregarBotonInterval() {
  const selector = document.getElementById("selector_dinamico");
  if (!selector) return;

  const boton = document.createElement("button");
  boton.id = "btn_select_interval";
  boton.textContent = "Select interval";

  // Estilo inline tipo Frutiger Aero
  boton.style.display = "block";
  boton.style.marginTop = "12px";
  boton.style.padding = "10px 18px";
  boton.style.fontSize = "14px";
  boton.style.borderRadius = "10px";
  boton.style.border = "1px solid rgba(255,255,255,0.7)";
  boton.style.background = "linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(210,240,255,0.85) 45%, rgba(180,220,255,0.9) 100%)";
  boton.style.boxShadow = "0 2px 6px rgba(0,0,0,0.25), inset 0 1px 2px rgba(255,255,255,0.8)";
  boton.style.backdropFilter = "blur(4px)";
  boton.style.cursor = "pointer";

  selector.insertAdjacentElement("afterend", boton);
}


//pendiente
//agregarBotonInterval();


function setSpeedActiveInBox(box, speed) {
  if (!box) return;

  console.log("speed BOX:", speed);

  [...box.querySelectorAll('.videoClipperSpeedOptionButton')].forEach(btn => {
    const isActive = btn.dataset.speed === speed;

    // activar clase
    btn.classList.toggle('videoClipperSpeedActive', isActive);

    // aplicar estilos seg√∫n activo o no
    if (isActive) {
      btn.style.backgroundColor = "#7c55e6";
      btn.style.color = "white";
      btn.style.border = "1px solid #7c55e6";
    } else {
      btn.style.backgroundColor = "transparent";
      btn.style.color = ""; // color por defecto
      btn.style.border = "1px solid #999";
    }
  });
}


function setSpeed(box){
  const index_row_global = selected_rect.dataset.index_row_global; 
  const index = parseInt(selected_rect.dataset.indice);  
  //const video_params = unica_regla.rectangulos[index_row_global][index].video_audio_value; 
  const video_params = selected_rect.dataset.video_audio_value;
  console.log("video_params video_params:",video_params);
  let speed = 1; 
  if (video_params!=""){ 
        speed = parseFloat(video_params.split(",")[2]);
	console.log("speed speed:",speed);
	const speed_string = video_params.split(",")[2].toString();
	setSpeedActiveInBox(box, speed_string);  

  }	
}


//guardar valores
function abrirModalDinamico(htmlString,sub_property) {

  hide_vertical_line();

  const index_global_row = selected_rect.dataset.index_global_row;

  const box = document.getElementById('modal_box_dinamico');
  box.innerHTML = htmlString; // Insertar HTML din√°mico
  setSpeed(box);
  document.getElementById('modal_overlay_dinamico').style.display = 'flex';
 

  console.log("current_timeline[2]: ",current_timeline[2]);

  const indice = parseInt(selected_rect.dataset.indice);  
  const detalle = unica_regla.rectangulos[index_global_row][indice]; 
  let current_property_value = detalle.start_value;

  const firstDiv = box.querySelector("div");
  console.log("firstDiv.className: ",firstDiv.className);	
  if (firstDiv.className == "end_type"){
   	current_property_value = detalle.end_value;
  }
 
  
  const list_values = current_property_value.split(",");

  const lista_inputs_and_selects = obtenerInputsYSelects(htmlString); 

  for (let i = 0; i < lista_inputs_and_selects.length; i++) {
    let id = lista_inputs_and_selects[i][0];
    let tipo = lista_inputs_and_selects[i][1];
    console.log(id, tipo);
    const elem = document.getElementById(id);
    if (elem) {
	console.log("htmlString: ",htmlString); 
        console.log("input value: ",list_values[i]); 
	if (list_values[i]!=""){ 
	   if (tipo=="input"){	
        	elem.value = list_values[i];
		if (current_property_value==""){
			elem.value = "";
		} 
	   }else{ 
		console.log("9000: ",list_values[i],"current_filetype:",current_filetype);
		for (let opt of elem.options) {
			console.log("opt: ",opt);
		    if (opt.value === list_values[i]) {
		      elem.value = list_values[i];
			if (list_values[i]){
				const div_interval = document.getElementById("btn_select_interval");
				if (div_interval && current_filetype=="video"){ 
					div_interval.style.display = "block";
				}
				if (div_interval && current_filetype=="audio"){ 
					div_interval.style.display = "block";
				}
			}
		      break;
		    }
	        }
	   }	
	}
    }
  }

  
   
 

} 




function abrirModalDinamicoSimple(htmlString) {

  hide_vertical_line();

  const box = document.getElementById('modal_box_dinamico');
  box.innerHTML = htmlString; // Insertar HTML din√°mico
  document.getElementById('modal_overlay_dinamico').style.display = 'flex';
 
} 
  

function eliminarTabPorNombre_0(tabName) {
  const container = document.getElementById('tabs-scroll-container');
  if (!container) return;

  const tab = container.querySelector(`[data-tab-name="${tabName}"]`);
  if (tab) {
	const json_data =  {"service":"de4lete_item","item_to_delete":current_item,"extra":"de4lete_item"}; 
	websocketClient.send(JSON.stringify(json_data)); 
        tab.remove();
  }
}


function reset_variables(){

    offsetVirtual = 0;
    marcadoresEnDOM = new Map();
    labelsEnDOM = new Map();
    todosLosMarcadores = [];
    todosLosLabels = [];
    rectangulos = [];

    arrastreActivo = false;
    rectanguloArrastrado = null;
    offsetInicialX = 0;
    posicionInicialRect = 0;

    redimensionActiva = false;
    rectanguloRedimensionado = null;
    ladoRedimension = '';
    posicionInicialMouse = 0;
    anchoInicial = 0;
    posicionInicialRectRedim = 0;
    rectanguloSeleccionado = null;

    filenames_llenos = 0;
    textnames_llenos = 0;
    current_item = "scene";
    current_property_id = "";
    customNames = ["scene"]; 
     
/*
    uploadedFiles = {};
    file_types = {
            "image": [],
            "video": [],
            "audio": [],
	    "text": []	
        };
 
    item_types = {
            "image": [],
            "video": [],
            "audio": []
        };
*/
}


function request_new_project(){

    reset_variables(); 

    //resolution_scene = "1280x720";
    console.log("eliminar todos los tabs y vaciar archivos subidos");
    closeModalDinamico();
    const json_data =  {"service":"new_project","resolution":resolution_scene,"itemName":current_item,"property":event.target.id,"params":"empty","file_type":selectedOption_item,"extra0":"","extra":""}; 
    websocketClient.send(JSON.stringify(json_data)); 
 
    const container = document.getElementById('tabs-scroll-container');
    if (!container) return; 
    const tabs = container.querySelectorAll('[data-tab-name]');
 
    const nombreAnterior = "scene";
    const tab = document.querySelector(`.tab[data-tab-name="${nombreAnterior}"]`);
    tab.dataset.modo = "delete_item";//si quito esto se ejecuta el save_item del cursor y eso modifica el valor de filename
    tab.click();

    // Elimina todos los tabs
    tabs.forEach(tab => {
      if (tab.dataset.tabName !== 'scene') {
        tab.remove();
      }
    });
 
 
}
 
function eliminarTabPorNombre(tabName) {
  const container = document.getElementById('tabs-scroll-container');
  if (!container) return;

  const tabActual = container.querySelector(`[data-tab-name="${tabName}"]`);
  if (!tabActual) return;

  const tabAnterior = tabActual.previousElementSibling;

  // Si no hay tab arriba, no se elimina nada
  if (!tabAnterior || !tabAnterior.hasAttribute('data-tab-name')) {
    console.log('No hay tab anterior, no se elimina');
    return;
  }

  customNames = customNames.filter(name => name !== current_item);

  // Imprime el data-tab-name del de arriba
  const nombreAnterior = tabAnterior.getAttribute('data-tab-name');
  console.log('Tab anterior:', nombreAnterior);

  //const json_data =  {"service":"delete_item","item_to_delete":current_item,"extra":"1","extra2":"2"}; 
  const json_data = {"service":"delete_item","item_to_delete":current_item,"itemName":current_item,"property":event.target.id,"params":"empty","file_type":selectedOption_item,"extra0":"","extra":""}; 

  websocketClient.send(JSON.stringify(json_data)); 

  const tab = document.querySelector(`.tab[data-tab-name="${nombreAnterior}"]`);
  tab.dataset.modo = "delete_item";//si quito esto se ejecuta el save_item del cursor y eso modifica el valor de filename
  tab.click(); 
   
  // Elimina el tab actual
  tabActual.remove();
}


 


document.addEventListener("click", function (e) {
    if (e.target.matches("#delete_item")){
	console.log("delete_item presionado");
	eliminarTabPorNombre(current_item);
	closeModalDinamico();
    } 

    if (e.target.matches("#log_in")){
	console.log("log_in");
	abrirModalDinamicoSimple(html_log_in);
    } 
    if (e.target.matches("#saved_projects")){
	abrirModalDinamicoSimple(html_saved_projects);
    }
    if (e.target.matches("#video_tutorials")){
	abrirModalDinamicoSimple(html_video_tutorials);
    }
    if (e.target.matches("#upgrade_plan")){
	abrirModalDinamicoSimple(html_upgrade_plan);
    }

    if (e.target.matches("#update_video")){
	request_render();
    }

    if (e.target.matches("#create_new_project")){
	request_new_project();
    }

     
  
    if (e.target.matches("#modal_overlay_dinamico")) { 
 
        e.target.style.display = "none"; 
	closeModalDinamico();
	console.log("‚úÖ‚úÖ‚úÖ‚úÖ "+timestamp_and_duration+","+current_speed, " ",rectangulos); 

	if (!selected_rect) return;
	const index_row = selected_rect.dataset.index_row; 
        const index_global_row = selected_rect.dataset.index_global_row;

	const box = document.getElementById('modal_box_dinamico');
	const divPrincipal = box.querySelector("div");
	console.log("‚úÖdivPrincipal.className: ",divPrincipal.className,divPrincipal);  // id del div principal

	const lista_inputs_and_selects = obtenerInputsYSelects_2(box);
  	console.log("lista_inputs_and_selects: ",lista_inputs_and_selects);

	let inputs_combined = "";
  	for (let i = 0; i < lista_inputs_and_selects.length; i++) {
    		let id = lista_inputs_and_selects[i][0];
    		let value = lista_inputs_and_selects[i][2];
		value = limpiarEspacios(value);
		if (id=="input_dynamic_box_0"){
		    if (value!=""){
			console.log("TEXNAME: ",value);
                        if (current_filetype=="text"){
				textnames_llenos = textnames_llenos + 1;
			}  
		    } 	
		}
    		console.log("save: ",id, value); 
		inputs_combined=inputs_combined+value;
		if (i<lista_inputs_and_selects.length-1){
			inputs_combined=inputs_combined+",";
		}
  	}

	if (divPrincipal.className == "start_type"){  
        	console.log("COMBINED =", inputs_combined);  
        	const valor = inputs_combined;
		const indice = parseInt(selected_rect.dataset.indice);
		 
		unica_regla.rectangulos[index_global_row][indice].start_value = valor;
        	rectangulos[index_row][indice].start_value = valor;  
        	actualizarEstadoGlobal();
  	}
	if (divPrincipal.className == "end_type"){  
        	console.log("COMBINED =", inputs_combined);  
        	const valor = inputs_combined;
		const indice = parseInt(selected_rect.dataset.indice);
		unica_regla.rectangulos[index_global_row][indice].end_value = valor;
        	rectangulos[index_row][indice].end_value = valor;  
        	actualizarEstadoGlobal();
  	}
	if (divPrincipal.className == "start_end_type"){  
		console.log("COMBINED =", inputs_combined);  
        	const valor = inputs_combined;
		const indice = parseInt(selected_rect.dataset.indice);

		if (unica_regla.rectangulos[index_global_row][indice].start_value.includes("/%(bounce)%/")){
			unica_regla.rectangulos[index_global_row][indice].start_value = valor+",/%(bounce)%/";
        		rectangulos[index_row][indice].start_value = valor+",/%(bounce)%/";  
		
			unica_regla.rectangulos[index_global_row][indice].end_value = valor+",/%(bounce)%/";
        		rectangulos[index_row][indice].end_value = valor+",/%(bounce)%/";  	 
		}else{
			unica_regla.rectangulos[index_global_row][indice].start_value = valor;
        		rectangulos[index_row][indice].start_value = valor;  
		
			unica_regla.rectangulos[index_global_row][indice].end_value = valor;
        		rectangulos[index_row][indice].end_value = valor;  
		} 

        	actualizarEstadoGlobal();
	}
	 
    }
});


 

 
 




 
document.addEventListener("click", (e) => {
    // Filtra solo si se hace click en el bot√≥n con id "btn_select_interval"
    const btn = e.target.closest("#btn_select_interval");
    if (!btn) return; // si no es ese bot√≥n, salir

    document.getElementById('modal_overlay_dinamico').style.display = 'none'; 
    const select = document.getElementById("selector_dinamico");
    if (select){	
    	const valor_seleccionado = select.value; 
    	console.log("valor_seleccionado interval: ",valor_seleccionado,unica_regla.rectangulos);
    	current_filename = valor_seleccionado;
        
        const url_object = filename_url[valor_seleccionado];
	console.log("error audio:",valor_seleccionado,", url: ",url_object);
    	abrirModalConClipper(url_object);
    }
});

 



const grupo = document.getElementById("grupo-botones");
grupo.addEventListener("click", (e) => {

    // ‚¨ÖÔ∏è Fila actual
    const index_row = selected_rect.dataset.index_row;
    const index_global_row = selected_rect.dataset.index_global_row;

    const filaRectangulos = rectangulos[index_row];          // lista de rect√°ngulos de esta fila
    const filaUnica = unica_regla.rectangulos[index_global_row];     // JSON de esta fila (si tu JSON es tambi√©n por fila)
    
    const btn = e.target.closest("button");
    if (!btn) return; // clic no en bot√≥n 
    const nombre_id = btn.id;
    if (!nombre_id) return; 

    if (nombre_id === "Add_file"){
	add_file();//simplemenus.js
	return;
    }
    if (nombre_id === "Add_box"){
	add_box();
	return;
    }
    if (nombre_id === "Split"){
	console.log("CURRENT SCROLL X:",current_scroll_x);
        if (selected_rect.dataset.filetype=="video" || selected_rect.dataset.filetype=="audio"){
		split_segment();
	}else{
		split_segment_no_duration();
	}
/*
	const files_reproducir_0 = filtrarSublistasPorProperty();
	const files_reproducir = transformList(files_reproducir_0);
	console.log("files_reproducir:",JSON.stringify(files_reproducir_0));
	console.log("files_reproducir:",JSON.stringify(files_reproducir));
*/
	return;
    }

    const current_filetype = selected_rect.dataset.filetype;
    const current_property_id = selected_rect.dataset.property;
     

    if (nombre_id === "Delete_box" || nombre_id === "Delete_file") { 

        resetOverlay();
        const indice = parseInt(selected_rect.dataset.indice);

        if (filaUnica.length <= 1) {
            showErrorModal('The last rectangle cannot be deleted.');
            return;
        } else {
            if (filaUnica.length == 2 && indice < filaUnica.length - 1) {
                if (filaRectangulos[indice+1] && 
                    typeof filaRectangulos[indice+1].start_value === "string" && 
                    filaRectangulos[indice+1].start_value.includes("/%(bounce)%/")) {
                    showErrorModal('The last rectangle cannot be deleted.');
                    return;
                }
            }
        }

        // 1Ô∏è‚É£ Eliminar del array local
        filaRectangulos[indice].elemento.remove();
        filaRectangulos.splice(indice, 1);

        // 2Ô∏è‚É£ Eliminar del JSON principal
        filaUnica.splice(indice, 1); 

        // 3Ô∏è‚É£ Reindexar dataset.indice de los rect√°ngulos restantes
        filaRectangulos.forEach((r, i) => {
            r.elemento.dataset.indice = i;
        });

        // üîÅ L√ìGICA EXTRA (DESPU√âS, SIN TOCAR NADA ARRIBA)
        if (
            filaRectangulos[indice] &&
            typeof filaRectangulos[indice].start_value === "string" &&
            filaRectangulos[indice].start_value.includes("/%(bounce)%/")
        ) {
            filaRectangulos[indice].elemento.remove();
            filaRectangulos.splice(indice, 1);
            filaUnica.splice(indice, 1);

            // reindexar otra vez
            filaRectangulos.forEach((r, i) => {
                r.elemento.dataset.indice = i;
            });
        }

        // 4Ô∏è‚É£ Limpiar los detalles
        deseleccionarRectangulo();

        // 5Ô∏è‚É£ Renderizar nuevamente
        renderizarElementosVisibles();

        actualizarEstadoGlobal(index_row); // ‚¨ÖÔ∏è si ahora recibe fila
    } else {
        console.log("000: ", current_filetype);
        if (dic_dynamic_options?.[current_filetype]?.[current_property_id]?.[nombre_id]) {
            let current_modal_html = dic_dynamic_options[current_filetype][current_property_id][nombre_id];
            if (current_filetype != "text" && current_property_id == "filename") {
                const current_files = file_types[current_filetype]; 
                current_modal_html = agregarOptions(current_modal_html, current_files);
            }
	    console.log("abrirModalDinamico MAL");
	    console.log(current_filetype,current_property_id,nombre_id);
	    console.log("current_modal_html: ",current_modal_html);			
            abrirModalDinamico(current_modal_html, nombre_id);
        } else {
            if (nombre_id == "bounce") {
                console.log("BOTON PRESIONADO B "); 
		crear_bounce_rectangle();
            } else {
                const current_modal_html = dic_dynamic_options["general"];
		console.log("abrirModalDinamico MAL 2",current_filetype, current_property_id, nombre_id);
		if (nombre_id=="Add_keyframes"){
			current_full_keyframes(); 
			return;
		} 	
                abrirModalDinamico(current_modal_html, nombre_id); 
            }
        }
    }

});

 
function hide_vertical_line(){
const overlay_regla = document.getElementById("overlay_regla");
if (overlay_regla){
	overlay_regla.style.display="none";
}
}
function show_vertical_line(){
const overlay_regla = document.getElementById("overlay_regla");
if (overlay_regla){
	overlay_regla.style.display="block";
}
}

function generarBotones(listaOpciones) { 
//hide_vertical_line();
    const contenedor = document.getElementById("botones-alineados");
    const grupo = document.getElementById("grupo-botones");
    const botones = grupo.querySelectorAll("button");

    const maxButtonWidth = 100;
    const minButtonWidth = 60;
    const total = listaOpciones.length;
    const anchoContenedor = contenedor.clientWidth;
    let anchoBoton;

    if (total <= 4) {
        anchoBoton = anchoContenedor / total;
        anchoBoton = Math.min(maxButtonWidth, Math.max(minButtonWidth, anchoBoton));
        contenedor.style.overflowX = "hidden";
    } else {
        anchoBoton = anchoContenedor / 4.5;
        anchoBoton = Math.min(maxButtonWidth, Math.max(minButtonWidth, anchoBoton));
        contenedor.style.overflowX = "auto";
    }

    // Limpiar botones visibles
    botones.forEach(btn => {
        btn.style.display = "none";
        btn.style.width = "";
        btn.style.backgroundColor = "";
    });

    // Asignar nombres visibles y color
    listaOpciones.forEach((nombre_id, i) => {//nombreVisible
	const nombreVisible = reemplazarGuionesPorEspacios(nombre_id);

        if (i >= botones.length) return;

        const btn = botones[i];

	btn.innerHTML = `
		  <span class="label">${nombreVisible}</span>
		`;
	if (nombreVisible === "Delete box") {
		btn.innerHTML = `
		  <span class="icon">
		    <svg xmlns="http://www.w3.org/2000/svg"
		         width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2"
		         stroke-linecap="round" stroke-linejoin="round">

		      <g transform="translate(3,3) scale(0.75)">
		        <path d="M3 6h18"/>
		        <path d="M8 6V4h8v2"/>
		        <path d="M6 6l1 14h10l1-14"/>
		        <line x1="10" y1="10" x2="10" y2="18"/>
		        <line x1="14" y1="10" x2="14" y2="18"/>
		      </g> 
		    </svg> 
		  </span>
		  <span class="label">Delete</span>
		`;
	}
	if (nombreVisible === "Delete file") {
		btn.innerHTML = `
		  <span class="icon">
		    <svg xmlns="http://www.w3.org/2000/svg"
		         width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2"
		         stroke-linecap="round" stroke-linejoin="round">

		      <g transform="translate(3,3) scale(0.75)">
		        <path d="M3 6h18"/>
		        <path d="M8 6V4h8v2"/>
		        <path d="M6 6l1 14h10l1-14"/>
		        <line x1="10" y1="10" x2="10" y2="18"/>
		        <line x1="14" y1="10" x2="14" y2="18"/>
		      </g> 
		    </svg> 
		  </span>
		  <span class="label">Delete</span>
		`;
	}

	if (nombreVisible === "Split") {
		btn.innerHTML = `
		  <span class="icon">
		    <svg xmlns="http://www.w3.org/2000/svg"
     width="35" height="31" viewBox="0 0 35 31" fill="none" stroke="#FFFFFF" stroke-width="2"
     stroke-linecap="round" stroke-linejoin="round">
  <g>
    <!-- Cuadrado izquierdo sin lado izquierdo -->
    <line x1="0" y1="10" x2="14" y2="10"/>      <!-- superior -->
    <line x1="14" y1="10" x2="14" y2="28"/>    <!-- derecha -->
    <line x1="0" y1="28" x2="14" y2="28"/>    <!-- inferior -->
    <!-- Cuadrado derecho sin lado derecho -->
    <line x1="21" y1="10" x2="35" y2="10"/>     <!-- superior -->
    <line x1="21" y1="10" x2="21" y2="28"/>    <!-- izquierda -->
    <line x1="21" y1="28" x2="35" y2="28"/>   <!-- inferior -->
  </g>
</svg>
		  </span>
		  <span class="label">Split</span>
		`;
	}

        if (nombreVisible === "Add file") {
		btn.innerHTML = `
		  <span class="icon">
  <svg xmlns="http://www.w3.org/2000/svg"
       width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round">
    <g transform="translate(3,3) scale(0.75)">
      <!-- Documento -->
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <!-- Esquina doblada -->
      <polyline points="14 2 14 8 20 8"/>
      <!-- S√≠mbolo + -->
      <line x1="12" y1="11" x2="12" y2="17"/>
      <line x1="9" y1="14" x2="15" y2="14"/>
    </g>
  </svg>
</span>
		  <span class="label">Add file</span>
		`;
	}


	if (nombreVisible === "Add box") {
		btn.innerHTML = `
		  <span class="icon">
  <svg xmlns="http://www.w3.org/2000/svg"
       width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round">
    <g transform="translate(3,3) scale(0.75)">
      <!-- Cuadrado con bordes redondeados -->
      <rect x="1" y="1" width="22" height="22" rx="3" ry="3"/>
      <!-- S√≠mbolo + -->
      <line x1="12" y1="6" x2="12" y2="18"/>
      <line x1="6" y1="12" x2="18" y2="12"/>
    </g>
  </svg>
</span>
		  <span class="label">Add</span>
		`;
	}


	if (nombreVisible === "Add keyframes") {
		btn.innerHTML = `
		  <span class="icon">
   			<svg xmlns="http://www.w3.org/2000/svg"
     width="35" height="35" viewBox="0 0 24 24">
  <!-- Rombo centrado -->
  <path
    d="M12 5 L19 12 L12 19 L5 12 Z"
    fill="#e0e0e0"
  />
  <!-- Signo + ligeramente m√°s largo -->
  <path
    d="M4 0v8M0 4h8"
    stroke="#e0e0e0"
    stroke-width="2"
    fill="none"
  />
</svg>
		</span>
		  <span class="label">Keyframes</span>
		`;
	}


 
	if (nombreVisible === "Text input"){
		btn.innerHTML = `
		  <span class="icon">
   			<svg xmlns="http://www.w3.org/2000/svg"
     width="35" height="35"
     viewBox="0 0 24 24"
     fill="none"
     stroke="#FFFFFF"
     stroke-width="2"
     stroke-linecap="round"
     stroke-linejoin="round">

  <g transform="translate(3,1) scale(0.8)">
    <!-- L√≠nea base -->
    <line x1="2" y1="22" x2="16" y2="22"/>

    <!-- L√°piz -->
    <path d="M14 1 L20 7 L10 17 L4 18 L5 12 Z"/>
  </g>
</svg>


		</span>
		  <span class="label">Text input</span>
		`;
	}
 


	if (nombreVisible === "keyframe 1") {
		btn.innerHTML = `
		  <span class="icon">
		    <svg xmlns="http://www.w3.org/2000/svg"
     width="35" height="35" viewBox="0 0 40 40">
  <!-- Rombo s√≥lido con lados iguales -->
  <polygon points="20,4 36,20 20,36 4,20" 
           fill="#e0e0e0" 
           stroke="none"/>
  <!-- N√∫mero en el centro -->
  <text x="20" y="22" font-size="20" font-family="Calibri, sans-serif"
        text-anchor="middle" dominant-baseline="middle"
        fill="rgb(48,48,48)" stroke="none">
    1
  </text>
</svg>
		    <span class="label">Keyframe</span> 
		  </span>
		   
		`;
	}
        if (nombreVisible === "keyframe 2") {
		btn.innerHTML = `
		  <span class="icon">
		    <svg xmlns="http://www.w3.org/2000/svg"
		         width="35" height="35" viewBox="0 0 40 40"
		         fill="none" stroke="#FFFFFF" stroke-width="3"
		         stroke-linejoin="round">

		      <!-- Rombo √∫nico ancho intermedio -->
		      <polygon points="7,20 20,4 33,20 20,36"/>

		      <!-- N√∫mero en el centro, ligeramente m√°s abajo -->
		      <text x="20" y="21" font-size="18" font-family="Calibri, sans-serif"
		            text-anchor="middle" dominant-baseline="middle"
		            fill="#FFFFFF" stroke="none">
		        2
		      </text>
		    </svg>  
		    <span class="label">Keyframe</span> 
		  </span>
		   
		`;
		btn.innerHTML = `
		  <span class="icon">
		    <svg xmlns="http://www.w3.org/2000/svg"
     width="35" height="35" viewBox="0 0 40 40">
  <!-- Rombo s√≥lido con lados iguales -->
  <polygon points="20,4 36,20 20,36 4,20" 
           fill="#e0e0e0" 
           stroke="none"/>
  <!-- N√∫mero en el centro -->
  <text x="20" y="22" font-size="20" font-family="Calibri, sans-serif"
        text-anchor="middle" dominant-baseline="middle"
        fill="rgb(48,48,48)" stroke="none">
    2
  </text>
</svg>
		    <span class="label">Keyframe</span> 
		  </span>
		   
		`;
	}
	if (nombreVisible === "bounce") {
		btn.innerHTML = `
		  <span class="icon">
		    <svg xmlns="http://www.w3.org/2000/svg"
		         width="35" height="35" viewBox="0 0 40 40"
		         fill="none">

		      <!-- Grupo escalado para ocupar 90% del SVG -->
		      <g transform="translate(2,2) scale(0.9)">
		        <!-- C√≠rculos s√≥lidos apilados con mayor desplazamiento -->
		        <circle cx="20" cy="20" r="10" fill="#FFFFFF" opacity="1"/>
		        <circle cx="24" cy="24" r="10" fill="#FFFFFF" opacity="0.75"/>
		        <circle cx="28" cy="28" r="10" fill="#FFFFFF" opacity="0.5"/>
		        <circle cx="32" cy="32" r="10" fill="#FFFFFF" opacity="0.25"/>

		        <!-- Signo "+" m√°s grande y alejado -->
		        <text x="6" y="6" font-size="28" font-family="Calibri, sans-serif"
		              text-anchor="middle" dominant-baseline="middle"
		              fill="#FFFFFF" stroke="none">
		          +
		        </text>
		      </g>
		    </svg> 
		    <span class="label">Add bounce</span> 
		  </span>
		   
		`;
	}
	if (nombreVisible === "bounce parameters") {
		btn.innerHTML = `
		  <span class="icon">
		    <svg xmlns="http://www.w3.org/2000/svg"
		         width="35" height="35" viewBox="0 0 40 40"
		         fill="none">

		      <!-- Grupo escalado para ocupar 90% del SVG -->
		      <g transform="translate(2,2) scale(0.9)">
		        <!-- C√≠rculos s√≥lidos apilados con mayor desplazamiento -->
		        <circle cx="20" cy="20" r="10" fill="#FFFFFF" opacity="1"/>
		        <circle cx="24" cy="24" r="10" fill="#FFFFFF" opacity="0.75"/>
		        <circle cx="28" cy="28" r="10" fill="#FFFFFF" opacity="0.5"/>
		        <circle cx="32" cy="32" r="10" fill="#FFFFFF" opacity="0.25"/>
		      </g>
		    </svg> 
		    <span class="label">Parameters</span> 
		  </span>
		   
		`;
	}
         
        //btn.textContent = nombreVisible;
        btn.style.width = anchoBoton + "px";

        // Color por defecto
        let color = "rgb(196, 205, 208)";//#02f57c
        color = "#e23445";
        if (nombreVisible === "Delete box") {
            color = "#e23445";//#e23445  
	    btn.style.textShadow = "1px 2px 4px rgba(0,0,0)";
	    btn.style.fontWeight = "bold"; 
        }else{
		//btn.style.color = "rgb(25,27,35)";
		btn.style.textShadow = "none"; 
		btn.style.fontWeight = "bold";
	}
	if (nombreVisible === "bounce parameters") {
		color = "rgb(255, 249, 105)";//yellow  
		//btn.style.minWidth = "150px"; 
	}else{
		btn.style.minWidth = "80px"; 
	}
	btn.style.height = "auto";//quitar  
        btn.style.backgroundColor = "transparent";//color
        //btn.style.display = "inline-block";
	btn.style.display = "flex";
	btn.style.flexDirection = "column";   // üîπ icono arriba / texto abajo
	btn.style.alignItems = "center";
	btn.style.justifyContent = "center"; 
	btn.id = nombre_id;
    });
    //grupo.style.justifyContent = total <= 4 ? "center" : "flex-start";
    if (window.innerWidth > 450){
    	grupo.style.justifyContent = "center";
    }else{
     	grupo.style.justifyContent = total <= 4 ? "center" : "flex-start";
	//grupo.style.justifyContent = "center";
    }	
}


window.addEventListener("resize", () => {
    generarBotones(box_options);  
});


 


 


 
function actualizarRectangulo(indice, rectNuevo) { 
    if (!unica_regla.rectangulos[indice]) return; // evita errores

    unica_regla.rectangulos[indice].start = rectNuevo.start;
    unica_regla.rectangulos[indice].end   = rectNuevo.end;
}






const array_real = [10,20,30];




//crear_loading_tab();


let reconnectTimeout = null;
let isReconnecting = false;
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 100;
 
function connect(type_connection) {


  if (websocketClient) {
    websocketClient.close();
    websocketClient = null;
  }

  if (reconnectTimeout) {
    clearTimeout(reconnectTimeout);
    reconnectTimeout = null;
  }

  isReconnecting = false; 


  const user_id = userId;
  const currentPath = "/path";
  const url_websocket = "rndomg84pbrg.onrender.com"; 
  websocketClient = new WebSocket("wss://" + url_websocket + "/" + user_id);
  websocketClient.binaryType = "arraybuffer";

  console.log("connecting..."); 

 
 

  websocketClient.addEventListener("open", () => {

    reconnectAttempts = 0;   // <-- AQU√ç S√ç
    isReconnecting = false;

    console.log("Client connected"); 
	
    hide_loading_tab();
    //createTab("scene");
 
    resetOverlay();
    inicializar();  
 
     
    const send_type_connection =
      "type_connection==" +
      type_connection +
      "==" +
      currentPath +
      "==" +
      user_id;
    websocketClient.send(send_type_connection);

 

  });

  websocketClient.addEventListener("message", (event) => {
    let message_result = event.data;

    if (typeof message_result === "string") {
 
/* 
      console.log("MENSAJE: ",message_result);
      if (message_result.startsWith("{") && message_result.endsWith("}")) {
        const data = JSON.parse(message_result);
	const service = data["service"];

	if (service=="change_item_view" || service=="max_duration"){ //|| service=="max_duration"

	  
 
	 
 

	resetOverlay();	
	 
         
	const list_params = data["params"].split("&");
        current_scroll_x = 0;
	if (list_params.length>0){
		for (let i=0;i<list_params.length;i++){
			if (list_params[i].split("=")[0]=="time"){
				current_scroll_x = parseFloat(list_params[i].split("=")[1]);
				break;
			}
		}
	}
        console.log("&&&&current_scroll_x: ",data["params"],", ",current_scroll_x);

	const item_name = data["itemName"]; 
	current_filetype = data["fileType"];

	if (item_types[current_filetype]){
	    if (!item_types[current_filetype].includes(item_name)){
		item_types[current_filetype].push(item_name);	
	    }
	}
	console.log("item_types: ",item_types);

	let property_id = data["property"];
	box_options = data["boxOptions"];
	current_box_options = box_options;
        console.log("PROPERTY: ",property_id);
	if (property_id=="timestamp_of_video_item"){
	    property_id = "filename";
	}
	const current_rectangles = data["rectangulos"];  
	const property_name = reemplazarGuionesPorEspacios(property_id);
	 
	const lista_propiedades = data["properties"];

	unica_regla.selectedProperty = property_id; 
	hide_loading_tab();
        //document.querySelector('.empty-block').style.display = "flex"; 

	 
	create_buttons_properties(lista_propiedades); 
	console.log("lista_propiedades: ",lista_propiedades); 
    	inicializar();   
	activarBoton(property_id);  
	 
	current_timeline[0] = lista_propiedades; 
	current_timeline[2] = property_id; 
	current_timeline[3] = item_name; 
	current_property_id = property_id; 
	current_item = item_name;
 
  	console.log("REAL VALUE: ",array_real[0]);
	 
 
	create_panel_tab(current_item+"_"+current_property_id);
	open_panel_tab(current_item+"_"+current_property_id);
  
	}
 
	 
 
 
      }
*/
 

    if (message_result === "ready_to_upload") {
      console.log("‚úÖ Servidor listo para recibir el archivo...");
      sendFile(currentFile);
    }

    if (false && message_result.includes("last_item_modified")){ 
	const data = JSON.parse(message_result); 
	console.log("last_item_modified: ",message_result);
	const last_item_modified = data["last_item_modified"].replace(/@/g, "");
 
const tab = document.querySelector(`.tab[data-tab-name="${last_item_modified}"]`);
tab.click();
 
    }

 

if (message_result === "all_chunks_received") {
  console.log("‚úÖ Subida completa:", currentFile.name);

  // Quita el porcentaje: normaliza el value de progress_visible_names al key
  const baseName = currentFile.name.replace(/\.[^/.]+$/, "");
  const extension = currentFile.name.match(/\.[^/.]+$/)?.[0] || "";

  const currentKey = Object.keys(progress_visible_names).find(k =>
    k.startsWith(baseName) && k.endsWith(extension)
  );

  if (currentKey) {
    progress_visible_names[currentKey] = currentKey; // value id√©ntico al key
    console.log("progress_visible_names:", progress_visible_names); 
  }

  // A√±ade a la lista de subidos (visible_names sigue igual que antes)
  const visibleKey = Object.keys(visible_names).find(k =>
    k.includes(baseName) && k.endsWith(extension)
  );
  if (visibleKey) uploaded_names.push(visibleKey);

  if (Object.keys(progress_visible_names).length === uploaded_names.length){
	console.log("activar boton de renderizado"); 
	//ocultar error_subidas_pendientes y pendientes_de_subir
	ocultarPendientesYErrores();
  }

  isUploading = false;
  currentFile = null;

  // Procesa el siguiente archivo en cola
  processNextUpload();
}









    }else{



if (event.data instanceof ArrayBuffer) {
/*
  const bytes = new Uint8Array(event.data);

 


  let firstInt =
    bytes[0] | (bytes[1] << 8) | (bytes[2] << 16) | (bytes[3] << 24);

 

  if (firstInt < 0) {
    const secondInt = (bytes[4] << 24) >> 24;

    if (secondInt >= 0) {
      type_video = "video/webm";
      video_extension = ".webm";
    } else {
      type_video = "video/mp4";
      video_extension = ".mp4";
    }

    if (globalBuffer.length == 0) {
      //destroyCancelButton();
    }

console.log("chunk: ", globalBuffer.length," ",Math.abs(firstInt));

     
    const subBuffer = bytes.subarray(5);
    suma_final = suma_final + subBuffer.byteLength;
    const newBuffer = new Uint8Array(globalBuffer.length + subBuffer.length);
    newBuffer.set(globalBuffer, 0);
    newBuffer.set(subBuffer, globalBuffer.length);

    globalBuffer = newBuffer;

    if (video_tag == "webm") {
      const current_load = [
        [globalBuffer.length, Math.abs(firstInt), "#0000FF"],
      ];
      generarBarras(current_load);
    } else {
      const current_load = [
        [
          globalBuffer.length,
          Math.abs(firstInt),
          "percentage",
          "#0000FF",
          "Preparing video . . .",
        ],
      ];
      draw_percentage(current_load);
    }

    if (globalBuffer.length == Math.abs(firstInt)) {
      console.log("FULL_VIDEO_RECEIVED");
      ocultarBarras();
      frameIndex = 0;
      n_seg = 0;
      watch(); 
      show_videoTag();
      show_vertical_line();	
      websocketClient.send("full_video_received_" + video_tag);
      const error_connection_2 = document.querySelector(".error-creation-2");
      if (error_connection_2) {
        error_connection_2.innerText = "Video rendered successfully";
        error_connection_2.style.display = "block";
      }
    }
  } else {
    const duracion_video = firstInt;
    const secondInt = (bytes[4] << 24) >> 24;
 
    if (secondInt > 0) {
      if (frameIndex == 0) {
	console.log("frameIndex: ", frameIndex);
        close_loading();
        if (duracion_video >= 0) {
          //createCancelButton();
        }
      }

      const current_load = [[n_seg, duracion_video, "#4caf50"]];
      generarBarras(current_load);
      const percentage = n_seg / duracion_video;
      if (percentage > 0.6) {
        //destroyCancelButton();
      }

      const chunk_data = bytes.subarray(5);
      const frames = getChunks(chunk_data);

console.log("chunk: ", frames.length); 

      feedFrames(frames, current_fps);
      if (current_fps < 17 && n_seg % 8 == 0) {
        current_fps = current_fps + 1;
      }
    } else {
      const current_load = [
        [n_seg, duracion_video, "time", "#4caf50", "Rendering video . . ."],
      ];
      draw_percentage(current_load);
      if (Math.abs(n_seg - duracion_video) <= 2) {
        clearCircle();
      }
    }
    n_seg = n_seg + 1;
  }
*/

/*
const bytes = new Uint8Array(event.data);

  // posici√≥n en segundos (little-endian)
  const posicion_en_segundos =
    bytes[0] |
    (bytes[1] << 8) |
    (bytes[2] << 16) |
    (bytes[3] << 24);

if (posicion_en_segundos > 0) {
  console.log("posicion_en_segundos:",posicion_en_segundos);

  const chunk_data = bytes.subarray(5);
  const encodedFrames = getChunks(chunk_data);  

  // √≠ndice inicial en la l√≠nea de tiempo
  const indiceInicial = posicion_en_segundos * TARGET_FPS;
  const indiceFinal = indiceInicial + TARGET_FPS;

  // Asegurar tama√±o del array y rellenar con "pendiente"
  asegurarPendientesHasta(indiceFinal);
  
  console.log("fotogramas_guardados.length",fotogramas_guardados.length);
  // Decodificar y colocar los frames
  decodeFrames(encodedFrames, TARGET_FPS).then((rawFrames) => {
    for (let i = 0; i < rawFrames.length; i++) {
      fotogramas_guardados[indiceInicial + i] = rawFrames[i];
    }
  }).catch(console.error);
}
*/

/*
  const bytes = new Uint8Array(event.data);

  const posicion_en_segundos =
    bytes[0] |
    (bytes[1] << 8) |
    (bytes[2] << 16) |
    (bytes[3] << 24);


  if (posicion_en_segundos < 0) {
      
    console.log("chunk: ", globalBuffer.length," ",Math.abs(posicion_en_segundos));
 
    const subBuffer = bytes.subarray(5); 
    const newBuffer = new Uint8Array(globalBuffer.length + subBuffer.length);
    newBuffer.set(globalBuffer, 0);
    newBuffer.set(subBuffer, globalBuffer.length);

    globalBuffer = newBuffer; 

    if (globalBuffer.length == Math.abs(posicion_en_segundos)) {
      console.log("FULL_VIDEO_RECEIVED"); 	
      websocketClient.send("full_video_received_" + video_tag); 
    }

  } else {
  console.log("posicion_en_segundos:",posicion_en_segundos);
  const chunk_data = bytes.subarray(5);
  const encodedFrames = getChunks(chunk_data); 

  const indiceInicial = posicion_en_segundos * TARGET_FPS;
  const indiceFinal = indiceInicial + TARGET_FPS;

  while (fotogramas_guardados.length < indiceFinal) {
    fotogramas_guardados.push(PENDIENTE);
  }
  console.log("fotogramas_guardados.length",fotogramas_guardados.length);

  decodeFrames(encodedFrames, TARGET_FPS)
    .then((rawFrames) => {
      for (let i = 0; i < rawFrames.length; i++) {
        setFrameSeguro(indiceInicial + i, rawFrames[i]);
      }
    })
    .catch(console.error);
  }
*/


/*
//muy bien
const bytes = new Uint8Array(event.data);
const posicion_en_segundos =
  bytes[0] |
  (bytes[1] << 8) |
  (bytes[2] << 16) |
  (bytes[3] << 24);

if (posicion_en_segundos < 0) {
  console.log("chunk:", globalBuffer.length, " ", Math.abs(posicion_en_segundos));
  
  const subBuffer = bytes.subarray(5);
  const newBuffer = new Uint8Array(globalBuffer.length + subBuffer.length);
  newBuffer.set(globalBuffer, 0);
  newBuffer.set(subBuffer, globalBuffer.length);
  globalBuffer = newBuffer;
  
  if (globalBuffer.length == Math.abs(posicion_en_segundos)) {
    console.log("FULL_VIDEO_RECEIVED");
    websocketClient.send("full_video_received_" + video_tag);
  }
} else {
  console.log("posicion_en_segundos:", posicion_en_segundos);
  
  const chunk_data = bytes.subarray(5);
  const encodedFrames = getChunks(chunk_data);
  
  console.log("Frames recibidos:", encodedFrames.length);
  
  const indiceInicial = posicion_en_segundos * TARGET_FPS;
  const indiceFinal = indiceInicial + encodedFrames.length;
  
  // Asegurar espacio en el array
  while (fotogramas_guardados.length < indiceFinal) {
    fotogramas_guardados.push(PENDIENTE);
  }
  
  decodeFrames(encodedFrames, TARGET_FPS)
    .then((rawFrames) => {
      console.log("Frames decodificados correctamente:", rawFrames.length);
      
      for (let i = 0; i < rawFrames.length; i++) {
        setFrameSeguro(indiceInicial + i, rawFrames[i]);
      }
      
      console.log("Frames guardados desde √≠ndice", indiceInicial, "hasta", indiceInicial + rawFrames.length - 1);
    })
    .catch((error) => {
      console.error("Error decodificando frames:", error);
      console.error("Stack:", error.stack);
    });
}
*/

/*
const bytes = new Uint8Array(event.data);
const posicion_en_segundos =
  bytes[0] |
  (bytes[1] << 8) |
  (bytes[2] << 16) |
  (bytes[3] << 24);

if (posicion_en_segundos < 0) {
  console.log("chunk:", globalBuffer.length, " ", Math.abs(posicion_en_segundos));
  
  const subBuffer = bytes.subarray(5);
  const newBuffer = new Uint8Array(globalBuffer.length + subBuffer.length);
  newBuffer.set(globalBuffer, 0);
  newBuffer.set(subBuffer, globalBuffer.length);
  globalBuffer = newBuffer;
  
  if (globalBuffer.length == Math.abs(posicion_en_segundos)) {
    console.log("FULL_VIDEO_RECEIVED");
    websocketClient.send("full_video_received_" + video_tag);
  }
} else {
  console.log("posicion_en_segundos:", posicion_en_segundos);
  
  const chunk_data = bytes.subarray(5);
  const encodedFrames = getChunks(chunk_data);
  
  console.log("Frames recibidos:", encodedFrames.length);
  
  const indiceInicial = posicion_en_segundos * TARGET_FPS;
  const indiceFinal = indiceInicial + encodedFrames.length;
  
  // Asegurar espacio en el array
  while (fotogramas_guardados.length < indiceFinal) {
    fotogramas_guardados.push(PENDIENTE);
  }
  
  console.log(`Array preparado: √≠ndices ${indiceInicial} a ${indiceFinal - 1}`);
  
  decodeFrames(encodedFrames, TARGET_FPS)
    .then((rawFrames) => {
      console.log("Frames decodificados correctamente:", rawFrames.length);
      console.log("Tipos de frames:", rawFrames.map((f, i) => f ? `${i}:‚úì` : `${i}:‚úó`).join(' '));
      
      let guardadosExitosos = 0;
      let fallosGuardado = 0;
      
      for (let i = 0; i < rawFrames.length; i++) {
        const frame = rawFrames[i];
        const indiceDestino = indiceInicial + i;
        
        if (frame !== null && frame !== undefined) {
          console.log(`Guardando frame ${i} en √≠ndice ${indiceDestino}`);
          setFrameSeguro(indiceDestino, frame);
          guardadosExitosos++;
        } else {
          console.error(`‚ùå Frame ${i} es null, NO se guardar√° en √≠ndice ${indiceDestino}`);
          fallosGuardado++;
        }
      }
      
      console.log(`‚úì Guardado completo: ${guardadosExitosos} exitosos, ${fallosGuardado} fallidos`);
      console.log(`Frames guardados desde √≠ndice ${indiceInicial} hasta ${indiceInicial + guardadosExitosos - 1}`);
      
      // ‚úÖ Verificar inmediatamente despu√©s de guardar
      console.log("=== Verificaci√≥n inmediata ===");
      for (let i = indiceInicial; i < indiceFinal; i++) {
        const stored = fotogramas_guardados[i];
        if (stored === PENDIENTE) {
          console.error(`‚ö†Ô∏è √çndice ${i} sigue PENDIENTE`);
        } else if (!stored) {
          console.error(`‚ö†Ô∏è √çndice ${i} es null/undefined`);
        } else {
          console.log(`‚úì √çndice ${i} OK`);
        }
      }
    })
    .catch((error) => {
      console.error("Error decodificando frames:", error);
      console.error("Stack:", error.stack);
    });
}
*/


/*
//LA MEJOR OPCION DE TODAS
const decodificacionesActivas = [];

const bytes = new Uint8Array(event.data);
const posicion_en_segundos =
  bytes[0] |
  (bytes[1] << 8) |
  (bytes[2] << 16) |
  (bytes[3] << 24);

if (posicion_en_segundos < 0) {
  console.log("chunk:", globalBuffer.length, " ", Math.abs(posicion_en_segundos));
  
  const subBuffer = bytes.subarray(5);
  const newBuffer = new Uint8Array(globalBuffer.length + subBuffer.length);
  newBuffer.set(globalBuffer, 0);
  newBuffer.set(subBuffer, globalBuffer.length);
  globalBuffer = newBuffer;
  
  if (globalBuffer.length == Math.abs(posicion_en_segundos)) {
    console.log("FULL_VIDEO_RECEIVED");
    websocketClient.send("full_video_received_" + video_tag);
    
    // ‚úÖ ESPERAR a que todas las decodificaciones terminen
    console.log(`‚è≥ Esperando ${decodificacionesActivas.length} decodificaciones...`);
    Promise.all(decodificacionesActivas).then(() => {
      console.log("‚úÖ TODAS las decodificaciones completadas");
      verificarFramesGuardados();
    });
  }
} else {
  console.log("posicion_en_segundos:", posicion_en_segundos);
  
  const chunk_data = bytes.subarray(5);
  const encodedFrames = getChunks(chunk_data);
  
  console.log(`üì¶ Chunk recibido: ${encodedFrames.length} frames para posici√≥n ${posicion_en_segundos}`);
  
  const indiceInicial = posicion_en_segundos * TARGET_FPS;
  const indiceFinal = indiceInicial + encodedFrames.length;
  
  while (fotogramas_guardados.length < indiceFinal) {
    fotogramas_guardados.push(PENDIENTE);
  }
  
  console.log(`Array preparado: √≠ndices ${indiceInicial} a ${indiceFinal - 1}`);
  console.log(`üîÑ Decodificaciones activas: ${decodificacionesActivas.length}`);
  
  // ‚úÖ Crear y guardar la promesa
  const decodificacionPromise = decodeFrames(encodedFrames, TARGET_FPS)
    .then((rawFrames) => {
      console.log(`‚úÖ Decodificaci√≥n completa para √≠ndices ${indiceInicial}-${indiceFinal - 1}: ${rawFrames.length} frames`);
      
      for (let i = 0; i < rawFrames.length; i++) {
        const frame = rawFrames[i];
        const indiceDestino = indiceInicial + i;
        
        if (frame !== null && frame !== undefined) {
          setFrameSeguro(indiceDestino, frame);
        } else {
          console.error(`‚ùå Frame ${i} es null en √≠ndice ${indiceDestino}`);
        }
      }
      
      console.log(`‚úì Frames guardados en √≠ndices ${indiceInicial}-${indiceFinal - 1}`);
      
      // Remover de activas
      const idx = decodificacionesActivas.indexOf(decodificacionPromise);
      if (idx > -1) {
        decodificacionesActivas.splice(idx, 1);
        console.log(`‚úì Decodificaciones restantes: ${decodificacionesActivas.length}`);
      }
    })
    .catch((error) => {
      console.error(`‚ùå Error decodificando √≠ndices ${indiceInicial}-${indiceFinal - 1}:`, error);
      
      const idx = decodificacionesActivas.indexOf(decodificacionPromise);
      if (idx > -1) decodificacionesActivas.splice(idx, 1);
    });
  
  decodificacionesActivas.push(decodificacionPromise);
}
*/
 

 
/* ===========================
   SISTEMA DE CACHE INTELIGENTE
=========================== */
  
 
  const bytes = new Uint8Array(event.data);
  const posicion_en_segundos =
    bytes[0] |
    (bytes[1] << 8) |
    (bytes[2] << 16) |
    (bytes[3] << 24);

  if (posicion_en_segundos >= 0){
    const chunk_data = bytes.subarray(5);
    
    // ‚úÖ GUARDAR DIRECTAMENTE SIN DECODIFICAR
    trozos_guardados[posicion_en_segundos] = chunk_data;
    
    console.log(`üì¶ Trozo ${posicion_en_segundos} guardado (${chunk_data.length} bytes)`);
  } 
 

/*
const bytes = new Uint8Array(event.data);
  const posicion_en_segundos =
    bytes[0] |
    (bytes[1] << 8) |
    (bytes[2] << 16) |
    (bytes[3] << 24);
    
  if (posicion_en_segundos >= 0) {
    const chunk_data = bytes.subarray(5);
    
    // ‚úÖ GUARDAR trozo codificado
    trozos_guardados[posicion_en_segundos] = chunk_data;
    console.log(`üì¶ Trozo ${posicion_en_segundos} guardado (${chunk_data.length} bytes)`);
    
    // ‚úÖ PRECARGAR INMEDIATAMENTE en background
    if (!trozosEnProceso.has(posicion_en_segundos)) {
      trozosEnProceso.add(posicion_en_segundos);
      
      console.log(`üîÑ Precargando trozo ${posicion_en_segundos} en background...`);
      
      // No usar await - decodificar en background
      TrozoDecoder.decodificarTrozo(posicion_en_segundos)
        .then(frames => {
          if (frames && frames.length > 0) {
            cache_segundos.set(posicion_en_segundos, frames);
            console.log(`‚úÖ Trozo ${posicion_en_segundos} cacheado autom√°ticamente (${frames.length} frames)`);
          } else {
            console.error(`‚ùå Trozo ${posicion_en_segundos} no gener√≥ frames`);
          }
        })
        .catch(err => {
          console.error(`‚ùå Error precargando trozo ${posicion_en_segundos}:`, err);
        })
        .finally(() => {
          trozosEnProceso.delete(posicion_en_segundos);
        });
    }
  }
*/
 









}



}

  });

 

  websocketClient.addEventListener("close", (event) => {  
 
        scheduleReconnect();
 
  });

  websocketClient.addEventListener("error", (error) => { 
        
	scheduleReconnect();
  });
}

function scheduleReconnect() {

  hide_loading_tab();
  crear_loading_tab();

  if (isReconnecting) return;
  isReconnecting = true;
 
  if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
    console.warn("L√≠mite de reconexiones alcanzado");
    return;
  }

  reconnectAttempts++; 

  frameIndex = 0;
  globalBuffer = new Uint8Array(0);
  ocultarBarras();
  n_seg = 0;

  console.log(`Reintentando conexi√≥n (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}) en 5s...`);

  reconnectTimeout = setTimeout(() => {
    connect("reconnecting");
  }, 5000);
}


function scheduleReconnect_0() {

  if (isReconnecting) return;
  isReconnecting = true;

  frameIndex = 0;
  globalBuffer = new Uint8Array(0);
  ocultarBarras();
  n_seg = 0;

  console.log("reconnecting in 5s...");

  reconnectTimeout = setTimeout(() => {
    connect("reconnecting");
  }, 5000);
}

connect("initial_configuration");//connected
 
 
 
 
function ajustarContenedor() {
/*
  ANCHO_VENTANA_VIRTUAL = window.innerWidth;

  contenedor.style.width = `${ANCHO_VENTANA_VIRTUAL}px`;
  contenedor.style.height = "100%";
  contenedor.style.maxHeight = "calc(49vh - 90px)";
  contenedor.style.overflowY = "auto";
  contenedor.style.overflowX = "auto";
  contenedor.style.position = "relative";
*/
}

  
/*
contenedor.addEventListener('scroll', (event) => {
      ajustarContenedor();
});
*/ 
 

console.log("VideoDecoder:",'VideoDecoder' in window);
console.log("VideoFrame:",'VideoFrame' in window);
console.log('crossOriginIsolated:', crossOriginIsolated);


// Al inicio, antes de usar el decoder
async function verificarSoporteCodec() {
  try {
    const support = await VideoDecoder.isConfigSupported({
      codec: "vp8"
    });
    
    console.log("VP8 soportado:", support.supported);
    
    if (!support.supported) {
      // Intentar con VP9
      const vp9Support = await VideoDecoder.isConfigSupported({
        codec: "vp09.00.10.08" // VP9 profile 0
      });
      console.log("VP9 soportado:", vp9Support.supported);
      
      // O intentar H.264
      const h264Support = await VideoDecoder.isConfigSupported({
        codec: "avc1.42E01E" // H.264 baseline
      });
      console.log("H.264 soportado:", h264Support.supported);
    }
    
    return support.supported;
  } catch (error) {
    console.error("Error verificando codec:", error);
    return false;
  }
}

// Llamar antes de iniciar
verificarSoporteCodec().then(soportado => {
  if (!soportado) {
    console.error("VP8 no soportado en este dispositivo");
    // Aqu√≠ puedes mostrar un mensaje al usuario o usar un fallback
  }
});
 
</script>


<script src="./design4/general.js"> </script>
<script src="./design4/send_files.js"> </script> 
<script src="./design4/clipcontainer.js"> </script>  
<script src="./design4/htmlstring.js"> </script>  
<script src="./design4/expressions4.js"> </script>   
<script src="./design4/panel_tabs.js"> </script>  
<script src="./design4/reglas.js"> </script>  
<script src="./design4/simplemenus.js"> </script> 
<script src="./design4/interaccion_rectangulos.js"> </script> 
<script src="./design4/organizar_reproduccion_precarga_bidireccional.js"> </script> 
 
</body>
</html> 
