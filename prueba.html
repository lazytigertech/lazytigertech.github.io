<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat con WebLLM y modelo Phi</title>
<style>
body { font-family: sans-serif; padding: 12px; }
#status { margin-bottom: 8px; font-size: 14px; }
#bar-container { width: 100%; border:1px solid #aaa; height:12px; background:#eee; margin-bottom:10px; }
#bar { height:12px; width:0%; background:#eee; transition: width 0.3s, background 0.3s; }
#chat { border:1px solid #ccc; padding:10px; width:100%; height:300px; overflow-y:auto; background:#f9f9f9; display:flex; flex-direction:column; gap:6px; }
.burbuja { padding:8px 12px; border-radius:12px; max-width:80%; }
.user { background:#d1e7ff; align-self:flex-end; }
.bot { background:#e2ffe2; align-self:flex-start; }
#input-area { display:flex; gap:6px; margin-top:8px; }
#msg { flex:1; padding:6px; font-size:14px; }
#send { padding:6px 12px; font-size:14px; }
</style>
</head>
<body>

<h3>Chat local con WebLLM (Phi)</h3>

<div id="status">Preparando modelo…</div>
<div id="bar-container"><div id="bar"></div></div>

<div id="chat"></div>

<div id="input-area">
  <input id="msg" placeholder="Escribe tu pregunta..." disabled />
  <button id="send" disabled>Enviar</button>
</div>

<script type="module">
import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

const statusEl = document.getElementById("status");
const bar = document.getElementById("bar");
const input = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const chat = document.getElementById("chat");

let engine = null;
let ready = false;

function addMessage(text, clase) {
  const div = document.createElement("div");
  div.className = `burbuja ${clase}`;
  div.innerHTML = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function init() {
  statusEl.innerText = "Descargando modelo…";

  engine = await CreateMLCEngine(
    "Phi-3.5-mini-instruct-q4f16_0-MLC",
    {
      initProgressCallback(p) {
        if (!p) return;
        // progreso numérico
        if (p.progress !== undefined) {
          const pct = Math.round(p.progress * 100);
          console.log("Progreso:", pct + "%");
          bar.style.width = pct + "%";
          bar.style.background = pct < 100 ? "#4caf50" : "#4caf50";
        }
      }
    }
  );

  bar.style.width = "100%";
  bar.style.background = "#4caf50";
  statusEl.innerText = "✔ Modelo listo — puedes escribir";
  input.disabled = false;
  sendBtn.disabled = false;
  ready = true;
}

async function enviar() {
  if (!ready) return;
  const text = input.value.trim();
  if (!text) return;
  addMessage(text, "user");
  input.value = "";
  sendBtn.disabled = true;

  let replyDiv = document.createElement("div");
  replyDiv.className = "burbuja bot";
  replyDiv.innerHTML = "…";
  chat.appendChild(replyDiv);
  chat.scrollTop = chat.scrollHeight;

  const response = await engine.chat.completions.create({
    messages: [
      { role: "user", content: text }
    ],
    stream: true
  });

  let reply = "";
  for await (const chunk of response) {
    const delta = chunk.choices[0]?.delta?.content || "";
    reply += delta;
    replyDiv.innerHTML = reply;
    chat.scrollTop = chat.scrollHeight;
  }

  sendBtn.disabled = false;
}

sendBtn.onclick = enviar;
input.addEventListener("keypress", e => { if (e.key === "Enter") enviar(); });

init();
</script>

</body>
</html>
 
